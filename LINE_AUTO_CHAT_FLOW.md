# LINE自動チャットフロー ロジック仕様書

## 📋 全体フロー概要

診断ページで「LINEで続きを確認」ボタンを押した後、またはLINE友達追加後、以下の自動フローが開始されます。

---

## 🔄 フロー1: 診断結果送信 → 物件確認

### トリガー
- **LIFF連携時**: `/api/line/link` が実行され、診断結果が送信された直後
- **友達追加時**: Follow eventで以前の案件がある場合、診断結果が送信された直後

### ステップ1: 診断結果メッセージ送信
**送信内容:**
```
✅ 診断結果を引き継ぎました！

【物件情報】
{物件名} {部屋番号}

【診断サマリー】
見積書合計: {金額}円
適正価格: {金額}円
💰 削減可能額: {金額}円
⚠️ リスクスコア: {点数}点

【削減可能項目】
❌ {項目名}: {金額}円
   → {理由}
...

【交渉推奨項目】
⚡ {項目名}: {金額}円
   → {理由}
...

「履歴」と送信すると、いつでも詳細を確認できます。
```

### ステップ2: 物件確認の質問（即座に送信）
**会話状態**: `property_confirm` に設定  
**メッセージタイプ**: Flex Message（リッチメッセージ）

**質問文:**
```
「物件の確認」

{物件名} {部屋番号}

[ボタン1: はい] [ボタン2: いいえ]
[ボタン3: 相談したい]
```

---

## 🔄 フロー2: 物件確認への回答分岐

### パターン2-1: 「はい」が選択された場合

**会話状態**: `property_confirm` → `application_intent` に変更

**次の質問を送信:**
```
「申し込みについて」

申し込みを希望しますか？

[ボタン1: 申し込みする] [ボタン2: 申し込みしない]
[ボタン3: 相談したい]
```

### パターン2-2: 「いいえ」が選択された場合

**会話状態**: `property_confirm` → `waiting_images` に変更

**メッセージ送信:**
```
ごめん、こちらに見積書と図面をLINEのチャットで直接送ってくれない？
```

**次のアクション**: ユーザーが画像を送信するまで待機

### パターン2-3: 「相談したい」が選択された場合

**会話状態**: `property_confirm` → `consultation` に変更

**メッセージ送信:**
```
了解だよ。じゃあ相談内容をざっくりにメッセージ（LINEのメッセージ）で教えてね。
```

**次のアクション**: ユーザーがテキストメッセージを送信するまで待機

---

## 🔄 フロー3: 申し込み希望への回答分岐（「はい」→「申し込みを希望しますか？」への回答）

### パターン3-1: 「申し込みする」が選択された場合

**会話状態**: `application_intent` → `completed` に変更

**メッセージ送信:**
```
承知しました。担当者より詳細な初期費用の見積もりと申し込み方法について連絡いたします。
```

**バックエンド処理**: 
- ログに記録: `[Manual action required] User {userId} wants to apply for case {caseId}`
- エージェントが手動で以下を実施:
  1. AD（広告料）の有無を確認
  2. 正確な初期費用を見積もり
  3. 申し込み方法を連絡

### パターン3-2: 「申し込みしない」が選択された場合

**会話状態**: `application_intent` → `completed` に変更

**メッセージ送信:**
```
そうか、じゃあ他の物件を探せるこちらのAIで物件探すシステムがあるからそちらを使ってね！

[ボタン: 物件を探す (Suumo)]
```
**リンクURL**: `https://suumo.jp/chintai/` (ダミー)

### パターン3-3: 「相談したい」が選択された場合

**会話状態**: `application_intent` → `consultation` に変更

**メッセージ送信:**
```
了解だよ。じゃあ相談内容をざっくりにメッセージ（LINEのメッセージ）で教えてね。
```

**次のアクション**: ユーザーがテキストメッセージを送信するまで待機

---

## 🔄 フロー4: 画像送信時の処理（「いいえ」→ 画像待ち）

### トリガー
- ユーザーが画像メッセージを送信した時
- 会話状態が `waiting_images` の場合

### 処理
**メッセージ送信:**
```
画像を確認しました。担当者より診断結果をご連絡いたします。
```

**バックエンド処理**:
- ログに記録: `[Manual action required] Image received from user {userId}, case {caseId}`
- エージェントが手動で画像を確認して診断結果を返信

**注意**: 会話状態は `waiting_images` のまま（`completed` には変更しない）

---

## 🔄 フロー5: 相談内容受信時の処理（「相談したい」→ テキスト待ち）

### トリガー
- ユーザーがテキストメッセージを送信した時
- 会話状態が `consultation` の場合
- かつ、メッセージが「はい」「いいえ」「履歴」などのシステムコマンドではない場合

### 処理
**会話状態**: `consultation` → `completed` に変更

**メッセージ送信:**
```
相談内容を承知しました。担当者より返信いたします。
```

**バックエンド処理**:
- ログに記録: `[Manual action required] Consultation from user {userId}, case {caseId}: {相談内容}`
- エージェントが手動で返信

---

## 🔄 フロー6: 初回友達追加時の処理

### トリガー
- Follow event（友達追加・ブロック解除）
- 以前の案件がない場合（新規ユーザー）

### 処理
**メッセージ送信:**
```
友だち追加ありがとうございます！🎉

賃貸初期費用AI診断の結果をこちらで確認できます。

診断ページで「LINEで続きを確認」ボタンを押して連携してください。
```

---

## 🔄 フロー7: 再友達追加時の処理（以前の案件がある場合）

### トリガー
- Follow event（友達追加・ブロック解除）
- 以前の案件がある場合（`getUserCases` または `getActiveCase` で取得可能）

### 処理
1. **最新の案件の診断結果を自動送信**（フロー1のステップ1と同じ）
2. **物件確認の質問を送信**（フロー1のステップ2と同じ）
3. その後、フロー2以降に従って進行

---

## 📝 その他の機能

### 「履歴」コマンド
**送信**: `履歴` / `りれき` / `history`

**応答**:
```
📋 あなたの案件履歴（直近5件）

1. {案件1の表示名}
2. {案件2の表示名}
...

番号を送信して案件を選択してください。
```

### 番号選択（1-5）
**送信**: `1` / `2` / `3` / `4` / `5`

**処理**:
- 選択した案件をアクティブ案件に設定
- 応答: `✅ 「{案件名}」を選択しました。\n\n詳細を確認するには「はい」と送信してください。`

### 「はい」コマンド（アクティブ案件がある場合）
**送信**: `はい` / `Yes` / `yes`

**応答**:
```
📊 案件詳細

提示額: ¥{金額}
適正額: ¥{金額}
削減可能額: ¥{金額}

リスクスコア: {点数}/100

プロからのアドバイス:
{アドバイス内容}

交渉が面倒、怖いと感じる方は、弊社で全ての交渉を代行しお得に契約できるようサポートが可能です。希望の場合はLINEでご相談ください。
```

---

## ⚠️ 重要な注意点

1. **会話状態の管理**
   - すべての状態変更は `setConversationState` で保存
   - 状態: `property_confirm` → `application_intent` / `waiting_images` / `consultation` → `completed`

2. **メッセージ処理の優先順位**
   1. 会話状態に基づく処理（`property_confirm`, `application_intent`, `consultation`, `waiting_images`）
   2. システムコマンド（「履歴」、番号選択、「はい」）
   3. その他のメッセージ（ヘルプメッセージを送信）

3. **手動対応が必要なタイミング**
   - 「申し込みする」が選択された時
   - 画像が送信された時（`waiting_images` 状態）
   - 相談内容が送信された時（`consultation` 状態）

4. **エラーハンドリング**
   - すべてのメッセージ送信は `try-catch` で囲む
   - LINE APIのエラーはログに記録し、ユーザーには適切なメッセージを返す
   - Webhookは常に200ステータスを返す（LINEの要件）

---

## 🔧 実装上のポイント

1. **Flex Message vs Template Message**
   - 物件確認、申し込み希望の質問: Flex Messageを使用（リッチデザイン）
   - 物件探すリンク: Template Message（buttons）を使用

2. **ボタンのアクション**
   - `type: 'message'` を使用
   - `text` プロパティに日本語を設定（例: `'はい'`, `'いいえ'`, `'申し込みする'`）
   - `label` プロパティも設定（表示用）

3. **診断結果送信のタイミング**
   - LIFF連携時（`/api/line/link`）: 即座に送信
   - 友達追加時（Follow event）: 以前の案件がある場合のみ送信

4. **裏コマンド（占いモード）**
   - `result.is_secret_mode === true` の場合
   - 物件確認の質問は送信しない
   - 占い結果のみ送信
