/**
 * è³ƒè²¸åˆæœŸè²»ç”¨è¨ºæ–­ API
 * 
 * ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ + è£ã‚³ãƒãƒ³ãƒ‰æ©Ÿèƒ½:
 * - è¦‹ç©æ›¸/å›³é¢ã®å ´åˆ â†’ é€šå¸¸ã®è¨ºæ–­
 * - é–¢ä¿‚ãªã„ç”»åƒã®å ´åˆ â†’ ç‰¹åˆ¥ãªè¨ºæ–­ï¼ˆå ã„/è¤’ã‚å€’ã—ï¼‰
 */

import { GoogleGenerativeAI } from "@google/generative-ai";
import { NextResponse } from "next/server";

export const maxDuration = 60;

// APIã‚­ãƒ¼ã®ç¢ºèª
const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
if (!GEMINI_API_KEY) {
  console.error("âŒ GEMINI_API_KEY ãŒç’°å¢ƒå¤‰æ•°ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
  console.error("ç’°å¢ƒå¤‰æ•°ã®ç¢ºèªæ–¹æ³•:");
  console.error("1. .env.local ãƒ•ã‚¡ã‚¤ãƒ«ã« GEMINI_API_KEY=your_key_here ã‚’è¿½åŠ ");
  console.error("2. Vercelã®å ´åˆã¯ç’°å¢ƒå¤‰æ•°è¨­å®šã§ GEMINI_API_KEY ã‚’è¿½åŠ ");
}

const genAI = new GoogleGenerativeAI(GEMINI_API_KEY || "");

export async function POST(req: Request) {
  try {
    // APIã‚­ãƒ¼ã®å†ç¢ºèªï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ï¼‰
    if (!GEMINI_API_KEY) {
      console.error("âŒ APIãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚: GEMINI_API_KEY ãŒæœªè¨­å®š");
      return NextResponse.json({ 
        error: "APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“", 
        details: "ã‚µãƒ¼ãƒãƒ¼ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚GEMINI_API_KEY ãŒç’°å¢ƒå¤‰æ•°ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚" 
      }, { status: 500 });
    }
    const formData = await req.formData();
    const estimateFile = formData.get("estimate") as File | null;
    const planFile = formData.get("plan") as File | null;
    const conditionFile = formData.get("condition") as File | null;

    if (!estimateFile) {
      return NextResponse.json({ error: "è¦‹ç©æ›¸ã®ç”»åƒãŒå¿…è¦ã§ã™" }, { status: 400 });
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®æ¤œè¨¼
    if (estimateFile.size > 20 * 1024 * 1024) {
      return NextResponse.json({ error: "è¦‹ç©æ›¸ã®ç”»åƒã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆ20MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ï¼‰" }, { status: 400 });
    }

    if (planFile && planFile.size > 20 * 1024 * 1024) {
      return NextResponse.json({ error: "å‹Ÿé›†å›³é¢ã®ç”»åƒã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆ20MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ï¼‰" }, { status: 400 });
    }

    if (conditionFile && conditionFile.size > 20 * 1024 * 1024) {
      return NextResponse.json({ error: "æ¡ä»¶æ¬„ã®ç”»åƒã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆ20MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ï¼‰" }, { status: 400 });
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã®æ¤œè¨¼
    if (!estimateFile.type.startsWith('image/')) {
      return NextResponse.json({ error: "è¦‹ç©æ›¸ã¯ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™" }, { status: 400 });
    }

    if (planFile && !planFile.type.startsWith('image/')) {
      return NextResponse.json({ error: "å‹Ÿé›†å›³é¢ã¯ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™" }, { status: 400 });
    }

    if (conditionFile && !conditionFile.type.startsWith('image/')) {
      return NextResponse.json({ error: "æ¡ä»¶æ¬„ã¯ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™" }, { status: 400 });
    }

    const parts: any[] = [];
    const estimateBuffer = Buffer.from(await estimateFile.arrayBuffer());
    parts.push({
      inlineData: { mimeType: estimateFile.type, data: estimateBuffer.toString("base64") },
    });

    if (planFile) {
      const planBuffer = Buffer.from(await planFile.arrayBuffer());
      parts.push({
        inlineData: { mimeType: planFile.type, data: planBuffer.toString("base64") },
      });
    }

    if (conditionFile) {
      const conditionBuffer = Buffer.from(await conditionFile.arrayBuffer());
      parts.push({
        inlineData: { mimeType: conditionFile.type, data: conditionBuffer.toString("base64") },
      });
    }

    const primaryModel = process.env.GEMINI_MODEL_NAME || "gemini-2.5-pro";
    
    console.log("ğŸ”§ è¨­å®šç¢ºèª:");
    console.log("  - ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«:", primaryModel);
    console.log("  - APIã‚­ãƒ¼è¨­å®š:", GEMINI_API_KEY ? `âœ… è¨­å®šæ¸ˆã¿ (${GEMINI_API_KEY.substring(0, 10)}...)` : "âŒ æœªè¨­å®š");
    console.log("  - è¦‹ç©æ›¸ãƒ•ã‚¡ã‚¤ãƒ«:", estimateFile ? `âœ… ${estimateFile.name} (${estimateFile.size} bytes)` : "âŒ ãªã—");
    console.log("  - å›³é¢ãƒ•ã‚¡ã‚¤ãƒ«:", planFile ? `âœ… ${planFile.name} (${planFile.size} bytes)` : "ãªã—");
    console.log("  - æ¡ä»¶æ¬„ãƒ•ã‚¡ã‚¤ãƒ«:", conditionFile ? `âœ… ${conditionFile.name} (${conditionFile.size} bytes)` : "ãªã—");
    
    // ========================================
    // ã€ç¬¬1æ®µéšã€‘ç”»åƒã®ç¨®é¡ã‚’åˆ¤å®š
    // ========================================
    const classificationPrompt = `
ã“ã®ç”»åƒã‚’åˆ†æã—ã¦ã€ä»¥ä¸‹ã®ã©ã‚Œã«è©²å½“ã™ã‚‹ã‹åˆ¤å®šã—ã¦ãã ã•ã„ã€‚

1. "estimate" - è³ƒè²¸ã®è¦‹ç©æ›¸ãƒ»åˆæœŸè²»ç”¨æ˜ç´°æ›¸
2. "flyer" - è³ƒè²¸ã®å‹Ÿé›†å›³é¢ãƒ»ãƒã‚¤ã‚½ã‚¯
3. "face" - äººã®é¡”ãŒå†™ã£ã¦ã„ã‚‹å†™çœŸ
4. "animal" - å‹•ç‰©ãŒå†™ã£ã¦ã„ã‚‹å†™çœŸ
5. "food" - é£Ÿã¹ç‰©ã®å†™çœŸ
6. "scenery" - é¢¨æ™¯ãƒ»å»ºç‰©ã®å†™çœŸ
7. "other" - ãã®ä»–

JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„:
{
  "type": "estimate" | "flyer" | "face" | "animal" | "food" | "scenery" | "other",
  "confidence": 0-100,
  "description": "ç”»åƒã®ç°¡å˜ãªèª¬æ˜"
}
`;

    const classificationParts = [parts[0], { text: classificationPrompt }];
    
    const model = genAI.getGenerativeModel({ 
      model: primaryModel, 
      generationConfig: { 
        responseMimeType: "application/json",
        temperature: 0
      }
    });
    
    console.log("ğŸ” ç”»åƒåˆ†é¡é–‹å§‹... ãƒ¢ãƒ‡ãƒ«:", primaryModel);
    let classification;
    try {
      const classificationResult = await model.generateContent(classificationParts);
      const classificationText = classificationResult.response.text();
      console.log("âœ… åˆ†é¡APIå¿œç­”å—ä¿¡ï¼ˆæœ€åˆã®500æ–‡å­—ï¼‰:", classificationText.substring(0, 500));
      const cleanedClassification = classificationText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
      classification = JSON.parse(cleanedClassification);
      console.log("âœ… ç”»åƒåˆ†é¡æˆåŠŸ:", classification);
    } catch (classificationError: any) {
      console.error("âŒ ========== ç”»åƒåˆ†é¡ã‚¨ãƒ©ãƒ¼ ==========");
      console.error("ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—:", classificationError?.constructor?.name || typeof classificationError);
      console.error("ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:", classificationError?.message || "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—");
      console.error("ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯:", classificationError?.stack || "ã‚¹ã‚¿ãƒƒã‚¯ãªã—");
      
      // APIã‚­ãƒ¼é–¢é€£ã®ã‚¨ãƒ©ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
      if (classificationError?.message?.includes("API_KEY") || 
          classificationError?.message?.includes("api key") || 
          classificationError?.message?.includes("API key") ||
          classificationError?.message?.includes("401") ||
          classificationError?.message?.includes("403")) {
        console.error("âš ï¸ APIã‚­ãƒ¼é–¢é€£ã®ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ãŒé«˜ã„ã§ã™");
        console.error("GEMINI_API_KEY ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„");
      }
      
      console.error("=====================================");
      throw new Error(`ç”»åƒåˆ†é¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ${classificationError.message}`);
    }
    
    console.log("ç”»åƒåˆ†é¡çµæœ:", classification);

    // ========================================
    // ã€è£ã‚³ãƒãƒ³ãƒ‰ã€‘é–¢ä¿‚ãªã„ç”»åƒã®å ´åˆ
    // ========================================
    if (classification.type !== "estimate" && classification.type !== "flyer") {
      console.log("è£ã‚³ãƒãƒ³ãƒ‰ç™ºå‹•ï¼ç”»åƒã‚¿ã‚¤ãƒ—:", classification.type);
      
      let secretPrompt = "";
      
      if (classification.type === "face") {
        // é¡”å†™çœŸ â†’ å ã„é¢¨ã®è¨ºæ–­
        secretPrompt = `
ã‚ãªãŸã¯ä¼èª¬ã®å ã„å¸«ã€Œãƒãƒ€ãƒ ãƒ»ã‚¨ã‚¹ãƒ†ãƒ¼ãƒˆã€ã§ã™ã€‚
ã“ã®äººç‰©ã®å†™çœŸã‹ã‚‰ã€é‹å‘½ã‚’è©³ç´°ã«èª­ã¿è§£ã„ã¦ãã ã•ã„ã€‚

ã€é‡è¦ãƒ«ãƒ¼ãƒ«ã€‘
- å¿…ãšãƒã‚¸ãƒ†ã‚£ãƒ–ã§è¤’ã‚å€’ã™ï¼ˆãƒã‚¬ãƒ†ã‚£ãƒ–ãªè¡¨ç¾ã¯ç¦æ­¢ï¼‰
- å„é …ç›®ã¯3ã€œ4æ–‡ã§å…·ä½“çš„ã‹ã¤è©³ç´°ã«æ›¸ã
- é¡”ã®ç‰¹å¾´ã«è¨€åŠã—ãªãŒã‚‰é‹å‹¢ã‚’èªã‚‹
- éƒ¨å±‹æ¢ã—ã«çµ¡ã‚ãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å…¥ã‚Œã‚‹
- è¡Œå‹•æŒ‡é‡ã¯å…·ä½“çš„ã§å®Ÿè¡Œå¯èƒ½ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹

ã€ã‚¹ã‚³ã‚¢ã®ä»˜ã‘æ–¹ - é‡è¦ã€‘
ã‚¹ã‚³ã‚¢ã¯ãƒªã‚¢ãƒªãƒ†ã‚£ã‚’æŒãŸã›ã‚‹ãŸã‚ã«ã€é …ç›®ã”ã¨ã«ãƒãƒ©ã¤ãã‚’æŒãŸã›ã¦ãã ã•ã„ï¼š
- 65ã€œ95ã®ç¯„å›²ã§å¤‰å‹•ã•ã›ã‚‹
- å…¨é …ç›®ã‚’é«˜å¾—ç‚¹ã«ã—ãªã„ï¼ˆ1ã€œ2é …ç›®ã¯70ä»¥ä¸‹ã§ã‚‚è‰¯ã„ï¼‰
- å¾—æ„åˆ†é‡ã¯90ä»¥ä¸Šã€æˆé•·ä¸­ã®åˆ†é‡ã¯65ã€œ75ç¨‹åº¦
- ãŸã ã—ã€ã©ã®é …ç›®ã‚‚ãƒã‚¸ãƒ†ã‚£ãƒ–ãªè§£é‡ˆã§èª¬æ˜ã™ã‚‹

JSONå½¢å¼ã§å‡ºåŠ›:
{
  "fortune_title": "ãƒãƒ€ãƒ ãƒ»ã‚¨ã‚¹ãƒ†ãƒ¼ãƒˆã®é‹å‘½é‘‘å®š",
  "fortune_subtitle": "ã‚ãªãŸã ã‘ã®ç‰¹åˆ¥ãªé‹å‘½ã‚’èª­ã¿è§£ãã¾ã™",
  "fortune_person_type": "ã“ã®äººã®ã‚¿ã‚¤ãƒ—ã‚’ä¸€è¨€ã§ï¼ˆä¾‹: æƒ…ç†±çš„ãªãƒªãƒ¼ãƒ€ãƒ¼ã‚¿ã‚¤ãƒ—ã€ç©ã‚„ã‹ãªç™’ã—ç³»ã‚¿ã‚¤ãƒ— ãªã©ï¼‰",
  "fortune_items": [
    {
      "category": "ç·åˆé‹",
      "score": 75-92ã®æ•°å€¤ï¼ˆãƒªã‚¢ãƒ«ãªãƒãƒ©ã¤ãï¼‰,
      "icon": "â­",
      "detail": "3ã€œ4æ–‡ã§å…·ä½“çš„ãªé‹å‹¢ã‚’èªã‚‹ã€‚é¡”ã®ç‰¹å¾´ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹æ€§æ ¼ã‚„é‹å‘½ã«ã¤ã„ã¦è©³ã—ãæ›¸ãã€‚",
      "lucky_item": "ãƒ©ãƒƒã‚­ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆä¾‹: è¦³è‘‰æ¤ç‰©ã€ãƒ–ãƒ«ãƒ¼ã®ã‚¢ã‚¤ãƒ†ãƒ ãªã©ï¼‰"
    },
    {
      "category": "é‡‘é‹",
      "score": 65-90ã®æ•°å€¤ï¼ˆé …ç›®ã”ã¨ã«å¤‰ãˆã‚‹ï¼‰,
      "icon": "ğŸ’°",
      "detail": "é‡‘é‹ã«ã¤ã„ã¦ã®è©³ç´°ã€‚ãŠé‡‘ã®ä½¿ã„æ–¹ã‚„è²¯ã‚æ–¹ã®å‚¾å‘ã€ã“ã‚Œã‹ã‚‰è¨ªã‚Œã‚‹é‡‘é‹ã®æ³¢ã«ã¤ã„ã¦ã€‚ã‚¹ã‚³ã‚¢ãŒä½ã‚ã§ã‚‚ã€Œã“ã‚Œã‹ã‚‰ä¸Šæ˜‡ã®å…†ã—ã€ãªã©ãƒã‚¸ãƒ†ã‚£ãƒ–ã«ã€‚",
      "lucky_item": "é‡‘é‹ã‚¢ãƒƒãƒ—ã®ã‚¢ã‚¤ãƒ†ãƒ "
    },
    {
      "category": "æ‹æ„›é‹",
      "score": 68-95ã®æ•°å€¤ï¼ˆãƒãƒ©ã¤ãæŒãŸã›ã‚‹ï¼‰,
      "icon": "ğŸ’•",
      "detail": "æ‹æ„›é‹ã«ã¤ã„ã¦ã®è©³ç´°ã€‚ã“ã®äººã®é­…åŠ›ã‚„æ‹æ„›å‚¾å‘ã€å‡ºä¼šã„ã®ãƒãƒ£ãƒ³ã‚¹ã«ã¤ã„ã¦ã€‚",
      "lucky_item": "æ‹æ„›é‹ã‚¢ãƒƒãƒ—ã®ã‚¢ã‚¤ãƒ†ãƒ "
    },
    {
      "category": "ä»•äº‹é‹",
      "score": 70-93ã®æ•°å€¤,
      "icon": "ğŸ’¼",
      "detail": "ä»•äº‹é‹ã«ã¤ã„ã¦ã®è©³ç´°ã€‚ã“ã®äººã«å‘ã„ã¦ã„ã‚‹ä»•äº‹ã‚„æˆåŠŸã™ã‚‹ã‚³ãƒ„ã«ã¤ã„ã¦ã€‚",
      "lucky_item": "ä»•äº‹é‹ã‚¢ãƒƒãƒ—ã®ã‚¢ã‚¤ãƒ†ãƒ "
    },
    {
      "category": "ä½å±…é‹",
      "score": 80-98ã®æ•°å€¤ï¼ˆéƒ¨å±‹æ¢ã—é–¢é€£ãªã®ã§é«˜ã‚OKï¼‰,
      "icon": "ğŸ ",
      "detail": "ä½å±…é‹ã«ã¤ã„ã¦ã®è©³ç´°ã€‚ç›¸æ€§ã®è‰¯ã„ç‰©ä»¶ã®ç‰¹å¾´ã‚„ã€éƒ¨å±‹æ¢ã—ã®ãƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«ã¤ã„ã¦ã€‚å¿…ãšéƒ¨å±‹æ¢ã—ã«çµ¡ã‚ã‚‹ã€‚",
      "lucky_direction": "å‰æ–¹ä½ï¼ˆä¾‹: æ±å—ã€å—è¥¿ãªã©ï¼‰",
      "ideal_property": "ã“ã®äººã«åˆã†ç‰©ä»¶ã®ç‰¹å¾´"
    }
  ],
  "fortune_action_advice": [
    "ä»Šæ—¥ã‹ã‚‰å®Ÿè·µã§ãã‚‹å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹1ï¼ˆéƒ¨å±‹æ¢ã—ã«çµ¡ã‚ã‚‹ï¼‰",
    "å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹2",
    "å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹3"
  ],
  "fortune_lucky_color": "ãƒ©ãƒƒã‚­ãƒ¼ã‚«ãƒ©ãƒ¼",
  "fortune_lucky_number": "ãƒ©ãƒƒã‚­ãƒ¼ãƒŠãƒ³ãƒãƒ¼",
  "fortune_power_spot": "ãƒ‘ãƒ¯ãƒ¼ã‚¹ãƒãƒƒãƒˆï¼ˆä¾‹: ç¥ç¤¾ã€æµ·è¾ºãªã©ï¼‰",
  "fortune_summary": "300æ–‡å­—ä»¥ä¸Šã®è©³ç´°ãªç·æ‹¬ã€‚ã“ã®äººã®é‹å‘½ã€æ‰èƒ½ã€ã“ã‚Œã‹ã‚‰ã®å±•æœ›ã«ã¤ã„ã¦å£®å¤§ã«è¤’ã‚å€’ã™ã€‚æœ€å¾Œã¯å¿…ãšã€Œæœ€é«˜ã®ç‰©ä»¶ã¨ã®é‹å‘½çš„ãªå‡ºä¼šã„ãŒã€ã‚‚ã†ã™ããã“ã¾ã§æ¥ã¦ã„ã¾ã™âœ¨ã€ã§ç· ã‚ã‚‹ã€‚"
}
`;
      } else if (classification.type === "animal") {
        // å‹•ç‰© â†’ å‹•ç‰©é‘‘å®š
        secretPrompt = `
ã‚ãªãŸã¯ä¸–ç•Œçš„ã«æœ‰åãªå‹•ç‰©é‘‘å®šå£«ã€Œãƒ‰ã‚¯ã‚¿ãƒ¼ãƒ»ã‚¢ãƒ‹ãƒãƒ«ã‚¨ã‚¹ãƒ†ãƒ¼ãƒˆã€ã§ã™ã€‚
ã“ã®å‹•ç‰©ã‚’è©³ç´°ã«é‘‘å®šã—ã¦ãã ã•ã„ã€‚

ã€é‡è¦ãƒ«ãƒ¼ãƒ«ã€‘
- å¿…ãšãƒã‚¸ãƒ†ã‚£ãƒ–ã§è¤’ã‚å€’ã™ï¼ˆãƒã‚¬ãƒ†ã‚£ãƒ–ç¦æ­¢ï¼‰
- å„é …ç›®ã¯3ã€œ4æ–‡ã§å…·ä½“çš„ã«æ›¸ã
- å‹•ç‰©ã®ç‰¹å¾´ã‚’ç´°ã‹ãè¦³å¯Ÿã—ã¦è¨€åŠã™ã‚‹
- ãƒšãƒƒãƒˆå¯ç‰©ä»¶ã«çµ¡ã‚ãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å…¥ã‚Œã‚‹

ã€ã‚¹ã‚³ã‚¢ã®ä»˜ã‘æ–¹ - é‡è¦ã€‘
ã‚¹ã‚³ã‚¢ã¯ãƒªã‚¢ãƒªãƒ†ã‚£ã‚’æŒãŸã›ã‚‹ãŸã‚ã«ã€é …ç›®ã”ã¨ã«ãƒãƒ©ã¤ãã‚’æŒãŸã›ã¦ãã ã•ã„ï¼š
- 70ã€œ98ã®ç¯„å›²ã§å¤‰å‹•ã•ã›ã‚‹
- 1ã€œ2é …ç›®ã¯75ä»¥ä¸‹ã§ã‚‚OKï¼ˆæˆé•·ã®ä½™åœ°ã¨ã—ã¦ï¼‰
- ç‰¹ã«å„ªã‚ŒãŸç‚¹ã¯95ä»¥ä¸Šã«ã—ã¦ãƒ¡ãƒªãƒãƒªã‚’
- ã©ã®é …ç›®ã‚‚ãƒã‚¸ãƒ†ã‚£ãƒ–ãªè§£é‡ˆã§èª¬æ˜ã™ã‚‹ã“ã¨

JSONå½¢å¼ã§å‡ºåŠ›:
{
  "fortune_title": "ãƒ‰ã‚¯ã‚¿ãƒ¼ãƒ»ã‚¢ãƒ‹ãƒãƒ«ã‚¨ã‚¹ãƒ†ãƒ¼ãƒˆã®ç‰¹åˆ¥é‘‘å®š",
  "fortune_subtitle": "ã“ã®å­ã®ç´ æ™´ã‚‰ã—ã•ã‚’ç§‘å­¦çš„ã«è¨¼æ˜ã—ã¾ã™",
  "fortune_person_type": "ã“ã®å­ã®ã‚¿ã‚¤ãƒ—ï¼ˆä¾‹: ç”˜ãˆã‚“åŠãƒ—ãƒªãƒ³ã‚¹ã€ã‚¯ãƒ¼ãƒ«ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ¼ ãªã©ï¼‰",
  "fortune_items": [
    {
      "category": "å¯æ„›ã•",
      "score": 82-98ã®æ•°å€¤ï¼ˆãƒãƒ©ã¤ãæŒãŸã›ã‚‹ï¼‰,
      "icon": "ğŸ’–",
      "detail": "3ã€œ4æ–‡ã§ã“ã®å­ã®å¯æ„›ã•ã‚’å…·ä½“çš„ã«èª¬æ˜ã€‚è¡¨æƒ…ã€æ¯›ä¸¦ã¿ã€ç›®ã®è¼ããªã©ç´°éƒ¨ã«è¨€åŠã€‚",
      "lucky_item": "ã“ã®å­ãŒå–œã¶ã‚¢ã‚¤ãƒ†ãƒ "
    },
    {
      "category": "ç™’ã—ãƒ‘ãƒ¯ãƒ¼",
      "score": 75-95ã®æ•°å€¤,
      "icon": "âœ¨",
      "detail": "ã“ã®å­ãŒæŒã¤ç™’ã—ã®åŠ›ã«ã¤ã„ã¦è©³ã—ãã€‚è¦‹ã¦ã„ã‚‹ã ã‘ã§ã©ã‚“ãªåŠ¹æœãŒã‚ã‚‹ã‹ã‚’èªã‚‹ã€‚",
      "lucky_item": "ç™’ã—åŠ¹æœã‚’é«˜ã‚ã‚‹ã‚¢ã‚¤ãƒ†ãƒ "
    },
    {
      "category": "çŸ¥æ€§",
      "score": 68-92ã®æ•°å€¤ï¼ˆå€‹æ€§ã¨ã—ã¦ä½ã‚ã‚‚ã‚ã‚Šï¼‰,
      "icon": "ğŸ§ ",
      "detail": "ã“ã®å­ã®è³¢ã•ã«ã¤ã„ã¦ã€‚è¡¨æƒ…ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹çŸ¥æ€§ã€ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³èƒ½åŠ›ã«ã¤ã„ã¦ã€‚ã‚¹ã‚³ã‚¢ãŒä½ã‚ã®å ´åˆã¯ã€Œç´ ç›´ã•ã€ã€Œç„¡é‚ªæ°—ã•ã€ã¨ã—ã¦ãƒã‚¸ãƒ†ã‚£ãƒ–ã«ã€‚",
      "lucky_item": "çŸ¥æ€§ã‚’ä¼¸ã°ã™ã‚¢ã‚¤ãƒ†ãƒ "
    },
    {
      "category": "ã‚ªãƒ¼ãƒ©",
      "score": 78-96ã®æ•°å€¤,
      "icon": "ğŸŒŸ",
      "detail": "ã“ã®å­ãŒæ”¾ã¤ã‚ªãƒ¼ãƒ©ã«ã¤ã„ã¦ã€‚å‘¨ã‚Šã«ä¸ãˆã‚‹å½±éŸ¿åŠ›ã‚„å­˜åœ¨æ„Ÿã«ã¤ã„ã¦èªã‚‹ã€‚",
      "lucky_item": "ã‚ªãƒ¼ãƒ©ã‚’å¼·ã‚ã‚‹ã‚¢ã‚¤ãƒ†ãƒ "
    },
    {
      "category": "ä½å±…ç›¸æ€§",
      "score": 85-98ã®æ•°å€¤ï¼ˆç‰©ä»¶é–¢é€£ã¯é«˜ã‚OKï¼‰,
      "icon": "ğŸ ",
      "detail": "ã“ã®å­ã¨æš®ã‚‰ã™ã®ã«æœ€é©ãªç‰©ä»¶ã®ç‰¹å¾´ã€‚åºƒã•ã€æ—¥å½“ãŸã‚Šã€å‘¨è¾ºç’°å¢ƒã«ã¤ã„ã¦å…·ä½“çš„ã«ã€‚",
      "ideal_property": "ã“ã®å­ã«åˆã†ç‰©ä»¶ã®æ¡ä»¶",
      "lucky_direction": "å‰æ–¹ä½"
    }
  ],
  "fortune_action_advice": [
    "ã“ã®å­ã¨ã®ç”Ÿæ´»ã‚’æœ€é«˜ã«ã™ã‚‹ãŸã‚ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹1ï¼ˆãƒšãƒƒãƒˆå¯ç‰©ä»¶ã«çµ¡ã‚ã‚‹ï¼‰",
    "å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹2",
    "å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹3"
  ],
  "fortune_lucky_color": "ã“ã®å­ã®ãƒ©ãƒƒã‚­ãƒ¼ã‚«ãƒ©ãƒ¼",
  "fortune_lucky_number": "ãƒ©ãƒƒã‚­ãƒ¼ãƒŠãƒ³ãƒãƒ¼",
  "fortune_power_spot": "ã“ã®å­ã¨è¡Œãã¹ãå ´æ‰€",
  "fortune_summary": "300æ–‡å­—ä»¥ä¸Šã®è©³ç´°ãªç·æ‹¬ã€‚ã“ã®å­ã®ç´ æ™´ã‚‰ã—ã•ã‚’å£®å¤§ã«è¤’ã‚å€’ã™ã€‚æœ€å¾Œã¯ã€Œã“ã®å­ã¨æœ€é«˜ã®æš®ã‚‰ã—ãŒã§ãã‚‹ãƒšãƒƒãƒˆå¯ç‰©ä»¶ã€ãã£ã¨è¦‹ã¤ã‹ã‚Šã¾ã™ğŸ âœ¨ã€ã§ç· ã‚ã‚‹ã€‚"
}
`;
      } else if (classification.type === "food") {
        // é£Ÿã¹ç‰© â†’ ã‚°ãƒ«ãƒ¡é‘‘å®š
        secretPrompt = `
ã‚ãªãŸã¯ä¼èª¬ã®ç¾é£Ÿå®¶ã€Œã‚°ãƒ«ãƒ¡ãƒ»ã‚¨ã‚¹ãƒ†ãƒ¼ãƒˆå¿ã€ã§ã™ã€‚
ã“ã®æ–™ç†ã‚’è©³ç´°ã«é‘‘å®šã—ã¦ãã ã•ã„ã€‚

ã€é‡è¦ãƒ«ãƒ¼ãƒ«ã€‘
- å¿…ãšãƒã‚¸ãƒ†ã‚£ãƒ–ã§è¤’ã‚å€’ã™ï¼ˆãƒã‚¬ãƒ†ã‚£ãƒ–ç¦æ­¢ï¼‰
- å„é …ç›®ã¯3ã€œ4æ–‡ã§å…·ä½“çš„ã«æ›¸ã
- æ–™ç†ã®ç‰¹å¾´ã‚’ç´°ã‹ãè¦³å¯Ÿã—ã¦è¨€åŠã™ã‚‹
- ã‚­ãƒƒãƒãƒ³ã‚„ç‰©ä»¶ã«çµ¡ã‚ãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å…¥ã‚Œã‚‹

ã€ã‚¹ã‚³ã‚¢ã®ä»˜ã‘æ–¹ - é‡è¦ã€‘
ã‚¹ã‚³ã‚¢ã¯ãƒªã‚¢ãƒªãƒ†ã‚£ã‚’æŒãŸã›ã‚‹ãŸã‚ã«ã€é …ç›®ã”ã¨ã«ãƒãƒ©ã¤ãã‚’æŒãŸã›ã¦ãã ã•ã„ï¼š
- 65ã€œ96ã®ç¯„å›²ã§å¤‰å‹•ã•ã›ã‚‹
- 1ã€œ2é …ç›®ã¯70å°å‰åŠã§ã‚‚OKï¼ˆä¼¸ã³ã—ã‚ã¨ã—ã¦ï¼‰
- ç‰¹ã«å„ªã‚ŒãŸç‚¹ã¯90ä»¥ä¸Šã«ã—ã¦ãƒ¡ãƒªãƒãƒªã‚’
- ã©ã®é …ç›®ã‚‚ãƒã‚¸ãƒ†ã‚£ãƒ–ãªè§£é‡ˆã§èª¬æ˜ã™ã‚‹ã“ã¨

JSONå½¢å¼ã§å‡ºåŠ›:
{
  "fortune_title": "ã‚°ãƒ«ãƒ¡ãƒ»ã‚¨ã‚¹ãƒ†ãƒ¼ãƒˆå¿ã®ä¸‰ãƒ„æ˜Ÿé‘‘å®š",
  "fortune_subtitle": "ã“ã®é€¸å“ã®çœŸä¾¡ã‚’è¦‹æ¥µã‚ã¾ã™",
  "fortune_person_type": "æ–™ç†ã®æ ¼ä»˜ã‘ï¼ˆä¾‹: ãƒŸã‚·ãƒ¥ãƒ©ãƒ³ç´šã®é€¸å“ã€å¿ƒã‚’æº€ãŸã™ã‚½ã‚¦ãƒ«ãƒ•ãƒ¼ãƒ‰ ãªã©ï¼‰",
  "fortune_items": [
    {
      "category": "ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«",
      "score": 72-95ã®æ•°å€¤ï¼ˆãƒãƒ©ã¤ãæŒãŸã›ã‚‹ï¼‰,
      "icon": "ğŸ“¸",
      "detail": "3ã€œ4æ–‡ã§è¦‹ãŸç›®ã®ç´ æ™´ã‚‰ã—ã•ã‚’è©³ã—ãã€‚è‰²å½©ã€ç››ã‚Šä»˜ã‘ã€å™¨ã¨ã®èª¿å’Œã«ã¤ã„ã¦ã€‚",
      "lucky_item": "ã“ã®æ–™ç†ã«åˆã†é£²ã¿ç‰©"
    },
    {
      "category": "ç¾å‘³ã—ã•",
      "score": 78-96ã®æ•°å€¤,
      "icon": "ğŸ˜‹",
      "detail": "å‘³ã‚ã„ã®äºˆæ¸¬ã‚’è©³ã—ãã€‚é¦™ã‚Šã€é£Ÿæ„Ÿã€å‘³ã®ãƒãƒ©ãƒ³ã‚¹ã«ã¤ã„ã¦æƒ³åƒã—ã¦èªã‚‹ã€‚",
      "lucky_item": "å‘³ã‚’å¼•ãç«‹ã¦ã‚‹ã‚‚ã®"
    },
    {
      "category": "å¹¸ç¦åº¦",
      "score": 75-94ã®æ•°å€¤,
      "icon": "ğŸ’–",
      "detail": "ã“ã®æ–™ç†ã‚’é£Ÿã¹ãŸäººãŒã©ã‚Œã ã‘å¹¸ã›ã«ãªã‚Œã‚‹ã‹ã‚’èªã‚‹ã€‚å¿ƒç†çš„åŠ¹æœã«ã¤ã„ã¦ã€‚",
      "lucky_item": "å¹¸ç¦åº¦ã‚’ä¸Šã’ã‚‹ã‚‚ã®"
    },
    {
      "category": "æ–™ç†åŠ›",
      "score": 65-90ã®æ•°å€¤ï¼ˆè¬™è™šã•ã‚‚è©•ä¾¡ï¼‰,
      "icon": "ğŸ‘¨â€ğŸ³",
      "detail": "ä½œã‚Šæ‰‹ã®æ–™ç†ã‚¹ã‚­ãƒ«ã‚’è©³ã—ãè¤’ã‚ã‚‹ã€‚æŠ€è¡“ã€ã‚»ãƒ³ã‚¹ã€æ„›æƒ…ã«ã¤ã„ã¦ã€‚ã‚¹ã‚³ã‚¢ãŒæ§ãˆã‚ã§ã‚‚ã€Œå®¶åº­çš„ãªæ¸©ã‹ã¿ã€ãªã©ãƒã‚¸ãƒ†ã‚£ãƒ–ã«ã€‚",
      "lucky_item": "æ–™ç†åŠ›ã‚’ä¸Šã’ã‚‹ã‚¢ã‚¤ãƒ†ãƒ "
    },
    {
      "category": "ã‚­ãƒƒãƒãƒ³é‹",
      "score": 82-97ã®æ•°å€¤ï¼ˆç‰©ä»¶é–¢é€£ã¯é«˜ã‚OKï¼‰,
      "icon": "ğŸ ",
      "detail": "ã“ã®æ–™ç†ã‚’ä½œã‚Œã‚‹äººã«ãµã•ã‚ã—ã„ã‚­ãƒƒãƒãƒ³ã«ã¤ã„ã¦ã€‚ç†æƒ³ã®ç‰©ä»¶ã®æ¡ä»¶ã‚’èªã‚‹ã€‚",
      "ideal_property": "ç†æƒ³ã®ã‚­ãƒƒãƒãƒ³ã®æ¡ä»¶",
      "lucky_direction": "ã‚­ãƒƒãƒãƒ³ã®å‰æ–¹ä½"
    }
  ],
  "fortune_action_advice": [
    "æ–™ç†ã®è…•ã‚’æ´»ã‹ã™ãŸã‚ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹1ï¼ˆã‚­ãƒƒãƒãƒ³ä»˜ãç‰©ä»¶ã«çµ¡ã‚ã‚‹ï¼‰",
    "å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹2",
    "å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹3"
  ],
  "fortune_lucky_color": "æ–™ç†ã«åˆã†ã‚«ãƒ©ãƒ¼",
  "fortune_lucky_number": "ãƒ©ãƒƒã‚­ãƒ¼ãƒŠãƒ³ãƒãƒ¼",
  "fortune_power_spot": "é£Ÿã®é‹æ°—ã‚’ä¸Šã’ã‚‹å ´æ‰€",
  "fortune_summary": "300æ–‡å­—ä»¥ä¸Šã®è©³ç´°ãªç·æ‹¬ã€‚ã“ã®æ–™ç†ã¨ä½œã‚Šæ‰‹ã‚’å£®å¤§ã«è¤’ã‚å€’ã™ã€‚æœ€å¾Œã¯ã€Œã“ã‚“ãªç´ æ™´ã‚‰ã—ã„æ–™ç†ã‚’ä½œã‚Œã‚‹ã‚ãªãŸã«ã¯ã€åºƒã„ã‚­ãƒƒãƒãƒ³ã®ã‚ã‚‹ç‰©ä»¶ãŒãã£ã¨è¦‹ã¤ã‹ã‚Šã¾ã™ğŸ âœ¨ã€ã§ç· ã‚ã‚‹ã€‚"
}
`;
      } else {
        // ãã®ä»– â†’ ä¸‡èƒ½è¤’ã‚é‘‘å®š
        secretPrompt = `
ã‚ãªãŸã¯ã€Œä¸‡ç‰©é‘‘å®šå£«ãƒã‚¹ã‚¿ãƒ¼ãƒ»ã‚¨ã‚¹ãƒ†ãƒ¼ãƒˆã€ã§ã™ã€‚
ã“ã®ç”»åƒã‚’è©³ç´°ã«é‘‘å®šã—ã¦ãã ã•ã„ã€‚

ç”»åƒã®å†…å®¹: ${classification.description}

ã€é‡è¦ãƒ«ãƒ¼ãƒ«ã€‘
- å¿…ãšãƒã‚¸ãƒ†ã‚£ãƒ–ã§è¤’ã‚å€’ã™ï¼ˆãƒã‚¬ãƒ†ã‚£ãƒ–ç¦æ­¢ï¼‰
- å„é …ç›®ã¯3ã€œ4æ–‡ã§å…·ä½“çš„ã«æ›¸ã
- ç”»åƒã®ç‰¹å¾´ã‚’ç´°ã‹ãè¦³å¯Ÿã—ã¦è¨€åŠã™ã‚‹
- ä¸å‹•ç”£ã‚„æ–°ç”Ÿæ´»ã«çµ¡ã‚ãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å…¥ã‚Œã‚‹

ã€ã‚¹ã‚³ã‚¢ã®ä»˜ã‘æ–¹ - é‡è¦ã€‘
ã‚¹ã‚³ã‚¢ã¯ãƒªã‚¢ãƒªãƒ†ã‚£ã‚’æŒãŸã›ã‚‹ãŸã‚ã«ã€é …ç›®ã”ã¨ã«ãƒãƒ©ã¤ãã‚’æŒãŸã›ã¦ãã ã•ã„ï¼š
- 65ã€œ95ã®ç¯„å›²ã§å¤‰å‹•ã•ã›ã‚‹
- 1ã€œ2é …ç›®ã¯75ä»¥ä¸‹ã§ã‚‚OKï¼ˆæˆé•·ã®å¯èƒ½æ€§ã¨ã—ã¦ï¼‰
- ç‰¹ã«å„ªã‚ŒãŸç‚¹ã¯90ä»¥ä¸Šã«ã—ã¦ãƒ¡ãƒªãƒãƒªã‚’
- ã©ã®é …ç›®ã‚‚ãƒã‚¸ãƒ†ã‚£ãƒ–ãªè§£é‡ˆã§èª¬æ˜ã™ã‚‹ã“ã¨

JSONå½¢å¼ã§å‡ºåŠ›:
{
  "fortune_title": "ãƒã‚¹ã‚¿ãƒ¼ãƒ»ã‚¨ã‚¹ãƒ†ãƒ¼ãƒˆã®ç‰¹åˆ¥é‘‘å®š",
  "fortune_subtitle": "ã“ã®ç”»åƒã«ç§˜ã‚ã‚‰ã‚ŒãŸä¾¡å€¤ã‚’è¦‹æ¥µã‚ã¾ã™",
  "fortune_person_type": "ã“ã®ç”»åƒã®ã‚¿ã‚¤ãƒ—ï¼ˆä¾‹: èŠ¸è¡“çš„ã‚»ãƒ³ã‚¹ã®çµæ™¶ã€å¹¸é‹ã‚’å‘¼ã¶ä¸€æš ãªã©ï¼‰",
  "fortune_items": [
    {
      "category": "ç´ æ™´ã‚‰ã—ã•",
      "score": 75-93ã®æ•°å€¤ï¼ˆãƒãƒ©ã¤ãæŒãŸã›ã‚‹ï¼‰,
      "icon": "âœ¨",
      "detail": "3ã€œ4æ–‡ã§ã“ã®ç”»åƒã®ç´ æ™´ã‚‰ã—ã•ã‚’å…·ä½“çš„ã«èª¬æ˜ã€‚æ§‹å›³ã€è¢«å†™ä½“ã€é›°å›²æ°—ã«ã¤ã„ã¦ã€‚",
      "lucky_item": "ã“ã®ç”»åƒã«é–¢é€£ã™ã‚‹ãƒ©ãƒƒã‚­ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ "
    },
    {
      "category": "èŠ¸è¡“æ€§",
      "score": 68-92ã®æ•°å€¤,
      "icon": "ğŸ¨",
      "detail": "èŠ¸è¡“çš„ãªè¦³ç‚¹ã‹ã‚‰è©³ã—ãåˆ†æã€‚è‰²å½©ã€ãƒãƒ©ãƒ³ã‚¹ã€å°è±¡ã«ã¤ã„ã¦èªã‚‹ã€‚ã‚¹ã‚³ã‚¢ãŒæ§ãˆã‚ã§ã‚‚ã€Œç´ æœ´ãªç¾ã—ã•ã€ãªã©ãƒã‚¸ãƒ†ã‚£ãƒ–ã«ã€‚",
      "lucky_item": "èŠ¸è¡“æ€§ã‚’é«˜ã‚ã‚‹ã‚¢ã‚¤ãƒ†ãƒ "
    },
    {
      "category": "ã‚»ãƒ³ã‚¹",
      "score": 72-95ã®æ•°å€¤,
      "icon": "ğŸ’",
      "detail": "ã“ã®ç”»åƒã‚’é¸ã‚“ã /æ’®ã£ãŸäººã®ã‚»ãƒ³ã‚¹ã«ã¤ã„ã¦è©³ã—ãè¤’ã‚ã‚‹ã€‚",
      "lucky_item": "ã‚»ãƒ³ã‚¹ã‚’ç£¨ãã‚¢ã‚¤ãƒ†ãƒ "
    },
    {
      "category": "é‹æ°—",
      "score": 70-90ã®æ•°å€¤,
      "icon": "ğŸŒŸ",
      "detail": "ã“ã®ç”»åƒã‹ã‚‰æ„Ÿã˜ã‚‹é‹æ°—ã«ã¤ã„ã¦ã€‚è¦‹ãŸäººã«ã©ã‚“ãªè‰¯ã„å½±éŸ¿ãŒã‚ã‚‹ã‹ã€‚",
      "lucky_item": "é‹æ°—ã‚’ä¸Šã’ã‚‹ã‚¢ã‚¤ãƒ†ãƒ "
    },
    {
      "category": "ä½å±…é‹",
      "score": 80-96ã®æ•°å€¤ï¼ˆç‰©ä»¶é–¢é€£ã¯é«˜ã‚OKï¼‰,
      "icon": "ğŸ ",
      "detail": "ã“ã®ç”»åƒã‚’æŒã¤äººã®ä½å±…é‹ã«ã¤ã„ã¦ã€‚ç†æƒ³ã®ç‰©ä»¶ã¨ã®å‡ºä¼šã„ã«ã¤ã„ã¦èªã‚‹ã€‚",
      "ideal_property": "ç›¸æ€§ã®è‰¯ã„ç‰©ä»¶ã®ç‰¹å¾´",
      "lucky_direction": "å‰æ–¹ä½"
    }
  ],
  "fortune_action_advice": [
    "ã“ã®ç”»åƒã‹ã‚‰å¾—ã‚‰ã‚Œã‚‹å¹¸é‹ã‚’æ´»ã‹ã™ã‚¢ãƒ‰ãƒã‚¤ã‚¹1ï¼ˆç‰©ä»¶æ¢ã—ã«çµ¡ã‚ã‚‹ï¼‰",
    "å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹2",
    "å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹3"
  ],
  "fortune_lucky_color": "ãƒ©ãƒƒã‚­ãƒ¼ã‚«ãƒ©ãƒ¼",
  "fortune_lucky_number": "ãƒ©ãƒƒã‚­ãƒ¼ãƒŠãƒ³ãƒãƒ¼",
  "fortune_power_spot": "ãƒ‘ãƒ¯ãƒ¼ã‚¹ãƒãƒƒãƒˆ",
  "fortune_summary": "300æ–‡å­—ä»¥ä¸Šã®è©³ç´°ãªç·æ‹¬ã€‚ã“ã®ç”»åƒã¨æŒã¡ä¸»ã‚’å£®å¤§ã«è¤’ã‚å€’ã™ã€‚æœ€å¾Œã¯ã€Œã“ã®ã‚»ãƒ³ã‚¹ã‚’ãŠæŒã¡ã®ã‚ãªãŸã«ã¯ã€ãã£ã¨æœ€é«˜ã®ç‰©ä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã™ğŸ âœ¨ã€ã§ç· ã‚ã‚‹ã€‚"
}
`;
      }

      const secretParts = [parts[0], { text: secretPrompt }];
      const secretModel = genAI.getGenerativeModel({ 
        model: primaryModel, 
        generationConfig: { 
          responseMimeType: "application/json",
          temperature: 0.9 // å‰µé€ æ€§ã‚’ä¸Šã’ã‚‹
        }
      });
      
      try {
        console.log("ğŸ”® è£ã‚³ãƒãƒ³ãƒ‰è¨ºæ–­é–‹å§‹... ã‚¿ã‚¤ãƒ—:", classification.type);
        const secretResult = await secretModel.generateContent(secretParts);
        const secretText = secretResult.response.text();
        console.log("âœ… è£ã‚³ãƒãƒ³ãƒ‰AIå¿œç­”å—ä¿¡ï¼ˆæœ€åˆã®500æ–‡å­—ï¼‰:", secretText.substring(0, 500));
        
        const cleanedSecret = secretText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        const secretJson = JSON.parse(cleanedSecret);
        
        // è£ã‚³ãƒãƒ³ãƒ‰ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ 
        secretJson.is_secret_mode = true;
        secretJson.secret_type = classification.type;
        secretJson.has_unconfirmed_items = false;
        secretJson.unconfirmed_item_names = [];
        
        console.log("âœ… è£ã‚³ãƒãƒ³ãƒ‰è¨ºæ–­å®Œäº†ï¼");
        return NextResponse.json({ result: secretJson });
      } catch (secretError: any) {
        console.error("âŒ ========== è£ã‚³ãƒãƒ³ãƒ‰ã‚¨ãƒ©ãƒ¼ ==========");
        console.error("ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—:", secretError?.constructor?.name || typeof secretError);
        console.error("ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:", secretError?.message || "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—");
        console.error("ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯:", secretError?.stack || "ã‚¹ã‚¿ãƒƒã‚¯ãªã—");
        
        // APIã‚­ãƒ¼é–¢é€£ã®ã‚¨ãƒ©ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
        if (secretError?.message?.includes("API_KEY") || 
            secretError?.message?.includes("api key") || 
            secretError?.message?.includes("API key") ||
            secretError?.message?.includes("401") ||
            secretError?.message?.includes("403")) {
          console.error("âš ï¸ APIã‚­ãƒ¼é–¢é€£ã®ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ãŒé«˜ã„ã§ã™");
          console.error("GEMINI_API_KEY ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„");
        }
        
        console.error("=====================================");
        throw new Error(`è£ã‚³ãƒãƒ³ãƒ‰å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${secretError.message}`);
      }
    }

    // ========================================
    // ã€é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã€‘è¦‹ç©æ›¸/å›³é¢ã®è¨ºæ–­
    // ========================================
    console.log("é€šå¸¸è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰é–‹å§‹...");
    
    const prompt = `
ã‚ãªãŸã¯ã€Œå…¥å±…è€…ã®å‘³æ–¹ã‚’ã™ã‚‹ã€çµŒé¨“è±Šå¯Œãªä¸å‹•ç”£ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆã€ã§ã™ã€‚
è¦‹ç©æ›¸ã¨å‹Ÿé›†å›³é¢ã‚’**å³å¯†ã«ç…§åˆ**ã—ã€ä¸å½“ãªè²»ç”¨ã‚’è¦‹ã¤ã‘å‡ºã—ã¦ãã ã•ã„ã€‚

## ã€ç”»åƒã®èª¬æ˜ã€‘
- 1æšç›®: è¦‹ç©æ›¸ï¼ˆå¿…é ˆï¼‰
- 2æšç›®ä»¥é™: å‹Ÿé›†å›³é¢ï¼ˆãƒã‚¤ã‚½ã‚¯ï¼‰ã¾ãŸã¯æ¡ä»¶æ¬„ã®ã‚¢ãƒƒãƒ—ç”»åƒï¼ˆä»»æ„ï¼‰

---

## ã€ç¦æ­¢äº‹é …ãƒ»åˆ¶ç´„ã€‘
- **çµ¶å¯¾ã«ä½¿ç”¨ç¦æ­¢ã®ãƒ¯ãƒ¼ãƒ‰**: ã€ŒADã€ã€Œåºƒå‘Šæ–™ã€ã€Œãƒãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ³ã€ã€Œã‚­ãƒƒã‚¯ãƒãƒƒã‚¯ã€ãªã©ã®æ¥­ç•Œè£äº‹æƒ…ç”¨èªã¯ä¸€åˆ‡ä½¿ã‚ãªã„ã“ã¨
- **éåº¦ãªæœŸå¾…ã‚’æŒãŸã›ã‚‹è¡¨ç¾ã®ç¦æ­¢**: ã€Œä»²ä»‹æ‰‹æ•°æ–™ãŒ0å††ã«ãªã‚‹ã€ã¨ã„ã£ãŸä¿è¨¼ã§ããªã„å†…å®¹ã¯æ›¸ã‹ãªã„ã“ã¨
- **ä»²ä»‹æ‰‹æ•°æ–™ãŒè³ƒæ–™ã®0.5ãƒ¶æœˆåˆ†ï¼ˆç¨åˆ¥ï¼‰ä»¥ä¸‹ã®å ´åˆ**: çµ¶å¯¾ã«ã€Œå‰Šæ¸›å¯èƒ½ã€ã‚„ã€Œäº¤æ¸‰å¯èƒ½ã€ã«åˆ†é¡ã—ãªã„ã€‚å¿…ãšã€Œfairï¼ˆé©æ­£ï¼‰ã€ã¨ã™ã‚‹ã“ã¨

---

## ã€é‡è¦ã€‘é¡ä¼¼é …ç›®ã®åç§°ãƒãƒƒãƒãƒ³ã‚°

ä»¥ä¸‹ã®é …ç›®ã¯**åŒä¸€é …ç›®**ã¨ã—ã¦æ‰±ã£ã¦ãã ã•ã„ï¼š
- ã€Œå…¥å±…è€…å®‰å¿ƒã‚µãƒãƒ¼ãƒˆã€ã€Œ24æ™‚é–“ã‚µãƒãƒ¼ãƒˆã€ã€Œ24æ™‚é–“ãƒ©ã‚¤ãƒ•ã‚µãƒãƒ¼ãƒˆã€ã€Œå®‰å¿ƒã‚µãƒãƒ¼ãƒˆã€ã€Œç·Šæ€¥ã‚µãƒãƒ¼ãƒˆã€â†’ ã™ã¹ã¦åŒã˜
- ã€Œæ¶ˆæ¯’ã€ã€ŒæŠ—èŒã€ã€Œå®¤å†…æ¶ˆæ¯’ã€ã€Œå®¤å†…æŠ—èŒã€ã€Œæ¶ˆæ¯’æ–½å·¥ã€ã€ŒæŠ—èŒæ¶ˆè‡­ã€ã€Œå®¤å†…æŠ—èŒãƒ»æ¶ˆæ¯’æ–½å·¥è²»ã€â†’ ã™ã¹ã¦åŒã˜

---

## ã€æœ€é‡è¦ã€‘åˆ¤å®šãƒ«ãƒ¼ãƒ«ã¨4ã¤ã®ã‚«ãƒ†ã‚´ãƒª

ä»¥ä¸‹ã®å„ªå…ˆé †ä½ã«å¾“ã£ã¦ã€æ©Ÿæ¢°çš„ã«åˆ¤å®šã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

### å„ªå…ˆé †ä½1ï¼šã€ä»²ä»‹æ‰‹æ•°æ–™ã®å³æ ¼åˆ¤å®šã€‘
| æ¡ä»¶ | åˆ¤å®š (status) | é©æ­£ä¾¡æ ¼ (price_fair) | ç†ç”± (reason) |
| :--- | :--- | :--- | :--- |
| **è³ƒæ–™ã®1.1ãƒ¶æœˆåˆ†ï¼ˆç¨è¾¼ï¼‰ã®å ´åˆ** | **negotiable** | è³ƒæ–™ã®0.55ãƒ¶æœˆåˆ†ï¼ˆç¨è¾¼ï¼‰ | "åŸå‰‡ã¯è³ƒæ–™ã®0.5ãƒ¶æœˆåˆ†ï¼ˆç¨åˆ¥ï¼‰ï¼0.55ãƒ¶æœˆåˆ†ï¼ˆç¨è¾¼ï¼‰ã§ã™ã€‚äº¤æ¸‰ã«ã‚ˆã‚Šæ¸›é¡ã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚" |
| **è³ƒæ–™ã®0.55ãƒ¶æœˆåˆ†ï¼ˆç¨è¾¼ï¼‰ä»¥ä¸‹ã®å ´åˆ** | **fair** | ãã®ã¾ã¾ | "é©æ­£ãªé‡‘é¡ã§ã™ã€‚" |
| **ç«ç½ä¿é™ºãŒ2ä¸‡å††è¶…ã®å ´åˆ** | **negotiable** | 15,000ã€œ20,000 | "ç›¸å ´ã‚ˆã‚Šå‰²é«˜ã§ã™ã€‚è‡ªåˆ†ã§å®‰ã„ä¿é™ºï¼ˆå€Ÿå®¶äººè³ å„Ÿè²¬ä»»ä¿é™ºï¼‰ã«åŠ å…¥ã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚" |

### å„ªå…ˆé †ä½2ï¼šã€è¦ç¢ºèªé …ç›®ã€‘ï¼ˆWarningï¼‰
**å¯¾è±¡ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰**: å®³è™«é§†é™¤, å®¤å†…æ¶ˆæ¯’, æ¶ˆè‡­æŠ—èŒ, 24æ™‚é–“ã‚µãƒãƒ¼ãƒˆ, å®‰å¿ƒã‚µãƒãƒ¼ãƒˆ, ç·Šæ€¥ã‚µãƒãƒ¼ãƒˆ, äº‹å‹™æ‰‹æ•°æ–™, æ›¸é¡ä½œæˆè²»

**é‡è¦**: éµäº¤æ›è²»ç”¨ã¯å«ã‚ãªã„ã“ã¨ï¼ˆéµäº¤æ›ã¯é€šå¸¸å¿…é ˆã®ãŸã‚ï¼‰

1. **å›³é¢ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„å ´åˆ OR å›³é¢ã«è©²å½“é …ç›®ã®è¨˜è¼‰ãŒç¢ºèªã§ããªã„å ´åˆ**
   - åˆ¤å®š: **warning**
   - é©æ­£ä¾¡æ ¼: 0å††
   - ç†ç”±: "ä¸€èˆ¬çš„ã«ã¯ä»»æ„ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ãŒã€è²¸ä¸»ã‚„ç®¡ç†ä¼šç¤¾ãŒå¿…é ˆæ¡ä»¶ã¨ã—ã¦ã„ã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚Šã¾ã™ã€‚**å‹Ÿé›†å›³é¢ã¨ã®ç…§åˆã‚„ã€ç®¡ç†ä¼šç¤¾ã¸ã®ç¢ºèªãŒå¿…è¦ã§ã™ã€‚**"

2. **å›³é¢ã«è¨˜è¼‰ãŒã‚ã‚Šã€Œä»»æ„ã€ã€Œã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€ã¨æ˜è¨˜ã•ã‚Œã¦ã„ã‚‹å ´åˆ**
   - åˆ¤å®š: **cut**
   - é©æ­£ä¾¡æ ¼: 0å††
   - ç†ç”±: "ä»»æ„ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚ä¸è¦ã§ã‚ã‚Œã°å¤–ã›ã¾ã™ã€‚"

3. **å›³é¢ã«è¨˜è¼‰ãŒã‚ã‚Šã€Œå¿…é ˆã€ã¨æ˜è¨˜ã•ã‚Œã¦ã„ã‚‹å ´åˆ**
   - åˆ¤å®š: **negotiable**
   - é©æ­£ä¾¡æ ¼: 0å††
   - ç†ç”±: "å›³é¢ã«è¨˜è¼‰ãŒã‚ã‚Šã¾ã™ãŒã€äº¤æ¸‰æ¬¡ç¬¬ã§å¤–ã›ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"

### å„ªå…ˆé †ä½3ï¼šã€å‰Šæ¸›å¯èƒ½é …ç›®ã€‘ï¼ˆCut/Negotiableï¼‰
ä¸Šè¨˜ã®è¦ç¢ºèªé …ç›®ã§ã€å›³é¢ã«æ˜ç¢ºã«è¨˜è¼‰ãŒãªãã€ã‹ã¤ä¸€èˆ¬çš„ã«ä¸è¦ã¨åˆ¤æ–­ã§ãã‚‹é …ç›®

### å„ªå…ˆé †ä½4ï¼šã€ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆé …ç›®ã€‘ï¼ˆé©æ­£ï¼‰
å¯¾è±¡: **æ•·é‡‘, ç¤¼é‡‘, è³ƒæ–™, å‰å®¶è³ƒ, å…±ç›Šè²»/ç®¡ç†è²», æ›´æ–°æ–™, ä¿è¨¼ä¼šç¤¾åˆ©ç”¨æ–™, éµäº¤æ›ä»£, ç”ºå†…ä¼šè²», å£åº§æŒ¯æ›¿æ‰‹æ•°æ–™, ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°è²»**

1. **åŸºæœ¬ãƒ«ãƒ¼ãƒ«**
   - è¦‹ç©æ›¸ã«è¨˜è¼‰ãŒã‚ã‚Œã°ã€**å›³é¢ã‹ã‚‰èª­ã¿å–ã‚Œãªãã¦ã‚‚ "fair"** ã¨åˆ¤å®šã™ã‚‹
   - ç†ç”±: "ç‰©ä»¶å›ºæœ‰ã®æ¡ä»¶ã§ã‚ã‚Šã€é©æ­£ãªè²»ç”¨ã§ã™ã€‚"

2. **ä¾‹å¤–ï¼ˆCutã«ã™ã‚‹ã‚±ãƒ¼ã‚¹ï¼‰**
   - å›³é¢ã«æ˜ç¢ºã«**ã€Œç¤¼é‡‘0å††ã€ã€Œç¤¼é‡‘ãªã—ã€ã€Œéµäº¤æ›ä»£ç„¡ã€**ã¨ã„ã†æ–‡å­—ãŒèª­ã¿å–ã‚ŒãŸå ´åˆã«é™ã‚Šã€**cut** ã¨ã™ã‚‹

---

## ã€å‡ºåŠ›å½¢å¼ã€‘JSON

Markdownè¨˜æ³•ã¯å«ã‚ãšã€ç´”ç²‹ãªJSONæ–‡å­—åˆ—ã ã‘ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚

**é‡è¦**: "warning" é …ç›®ã®é‡‘é¡ã¯ã€discount_amountã‚„total_fairã®è¨ˆç®—ã«å«ã‚ãªã„ã“ã¨ã€‚

{
  "property_name": "ç‰©ä»¶åï¼ˆä¸æ˜ãªã‚‰'ç‰©ä»¶åå…¥åŠ›ãªã—'ï¼‰",
  "room_number": "å·å®¤",
  "items": [
    {
      "name": "è¦‹ç©æ›¸ã«è¨˜è¼‰ã•ã‚ŒãŸé …ç›®å",
      "price_original": è¦‹ç©æ›¸ã®é‡‘é¡ï¼ˆæ•°å€¤ï¼‰,
      "price_fair": é©æ­£ä¾¡æ ¼ï¼ˆæ•°å€¤ï¼‰,
      "status": "fair|negotiable|cut|warning",
      "reason": "ä¸Šè¨˜ã®åˆ¤å®šãƒ«ãƒ¼ãƒ«ã«åŸºã¥ã„ãŸå…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹",
      "is_insurance": true/falseï¼ˆç«ç½ä¿é™ºã®å ´åˆã®ã¿trueï¼‰
    }
  ],
  "total_original": è¦‹ç©æ›¸åˆè¨ˆ,
  "total_fair": é©æ­£åˆè¨ˆï¼ˆwarningã¯å«ã‚ãšã€fairã¨negotiableã®ã¿ã§è¨ˆç®—ï¼‰,
  "discount_amount": å·®é¡ï¼ˆtotal_original - total_fairï¼‰,
  "warning_amount": warningé …ç›®ã®åˆè¨ˆé‡‘é¡,
  "has_flyer": å›³é¢ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ï¼ˆtrue/falseï¼‰,
  "pro_review": {
    "content": "ã“ã®ç‰©ä»¶ã®åˆæœŸè²»ç”¨ã«ãŠã‘ã‚‹æœ€å¤§ã®å•é¡Œç‚¹ã¨ã€æ¬¡ã«å–ã‚‹ã¹ãå…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‚warningé …ç›®ãŒã‚ã‚‹å ´åˆã¯å›³é¢ç¢ºèªã‚’ä¿ƒã™å†…å®¹ã‚’å«ã‚ã‚‹ã“ã¨ã€‚"
  },
  "risk_score": 0ã€œ100ï¼ˆå‰Šæ¸›é¡ã®å‰²åˆã«å¿œã˜ã¦ç®—å‡ºã€warningåˆ†ã¯å«ã‚ãªã„ï¼‰
}
`;

    parts.push({ text: prompt });
    
    console.log("ğŸ¤– é€šå¸¸è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰: AIãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡...");
    let result;
    let responseText;
    try {
      result = await model.generateContent(parts);
      responseText = result.response.text();
      console.log("âœ… AIå¿œç­”ã‚’å—ä¿¡ã—ã¾ã—ãŸï¼ˆé•·ã•:", responseText.length, "æ–‡å­—ï¼‰");
    } catch (generateError: any) {
      console.error("âŒ ========== AIç”Ÿæˆã‚¨ãƒ©ãƒ¼ ==========");
      console.error("ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—:", generateError?.constructor?.name || typeof generateError);
      console.error("ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:", generateError?.message || "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—");
      console.error("ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯:", generateError?.stack || "ã‚¹ã‚¿ãƒƒã‚¯ãªã—");
      
      // APIã‚­ãƒ¼é–¢é€£ã®ã‚¨ãƒ©ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
      if (generateError?.message?.includes("API_KEY") || 
          generateError?.message?.includes("api key") || 
          generateError?.message?.includes("API key") ||
          generateError?.message?.includes("401") ||
          generateError?.message?.includes("403")) {
        console.error("âš ï¸ APIã‚­ãƒ¼é–¢é€£ã®ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ãŒé«˜ã„ã§ã™");
        console.error("GEMINI_API_KEY ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„");
      }
      
      console.error("=====================================");
      throw generateError;
    }
    
    // JSONãƒ‘ãƒ¼ã‚¹
    let json;
    try {
      const cleanedText = responseText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
      console.log("ğŸ“ ãƒ‘ãƒ¼ã‚¹å‰ã®ãƒ†ã‚­ã‚¹ãƒˆï¼ˆæœ€åˆã®1000æ–‡å­—ï¼‰:", cleanedText.substring(0, 1000));
      json = JSON.parse(cleanedText);
      console.log("âœ… JSONãƒ‘ãƒ¼ã‚¹æˆåŠŸ");
    } catch (parseError: any) {
      console.error("âŒ ========== JSON Parse Error ==========");
      console.error("ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:", parseError.message);
      console.error("ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯:", parseError.stack);
      console.error("ãƒ¬ã‚¹ãƒãƒ³ã‚¹å…¨æ–‡ã®é•·ã•:", responseText.length);
      console.error("ãƒ¬ã‚¹ãƒãƒ³ã‚¹å…¨æ–‡ï¼ˆæœ€åˆã®2000æ–‡å­—ï¼‰:", responseText.substring(0, 2000));
      console.error("ãƒ¬ã‚¹ãƒãƒ³ã‚¹å…¨æ–‡ï¼ˆæœ€å¾Œã®500æ–‡å­—ï¼‰:", responseText.substring(Math.max(0, responseText.length - 500)));
      console.error("=========================================");
      throw new Error(`AIã®å¿œç­”ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ${parseError.message}\nå¿œç­”ã®æœ€åˆã®500æ–‡å­—: ${responseText.substring(0, 500)}`);
    }
    
    // å¾Œå‡¦ç†
    if (json.items && Array.isArray(json.items)) {
      json.items = json.items.map((item: any) => {
        if (item.price_original === null) {
          return {
            ...item,
            price_original: 0,
            requires_confirmation: true,
            reason: item.reason + "ï¼ˆâ€»èª­ã¿å–ã‚Šè¦ç¢ºèªï¼‰"
          };
        }
        return {
          ...item,
          requires_confirmation: false
        };
      });
      
      const hasUnconfirmed = json.items.some((item: any) => item.requires_confirmation);
      json.has_unconfirmed_items = hasUnconfirmed;
      json.unconfirmed_item_names = json.items
        .filter((item: any) => item.requires_confirmation)
        .map((item: any) => item.name);
    }

    console.log("è¨ºæ–­å®Œäº†:", {
      items_count: json.items?.length,
      total_original: json.total_original,
      discount_amount: json.discount_amount
    });

    return NextResponse.json({ result: json });

  } catch (error: any) {
    console.error("âŒ ========== ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ ==========");
    console.error("ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—:", error?.constructor?.name || typeof error);
    console.error("ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:", error?.message || "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—");
    console.error("ã‚¨ãƒ©ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:", error?.status || "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãªã—");
    console.error("ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯:", error?.stack || "ã‚¹ã‚¿ãƒƒã‚¯ãªã—");
    
    // APIã‚­ãƒ¼é–¢é€£ã®ã‚¨ãƒ©ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
    if (error?.message?.includes("API_KEY") || error?.message?.includes("api key") || error?.message?.includes("API key")) {
      console.error("âš ï¸ APIã‚­ãƒ¼é–¢é€£ã®ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™");
      console.error("GEMINI_API_KEY ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„");
    }
    
    // Gemini APIã®ã‚¨ãƒ©ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
    if (error?.message?.includes("429") || error?.status === 429) {
      console.error("âš ï¸ APIãƒ¬ãƒ¼ãƒˆåˆ¶é™ã«é”ã—ã¾ã—ãŸ");
    }
    
    let errorMessage = "è§£æã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
    let errorDetails = error.message || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼";
    
    if (error.status === 429 || error.message?.includes('429')) {
      errorMessage = "APIãƒ¬ãƒ¼ãƒˆåˆ¶é™ã«é”ã—ã¾ã—ãŸ";
      errorDetails = "ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
    } else if (error.message?.includes("JSON")) {
      errorMessage = "AIã‹ã‚‰ã®å¿œç­”ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ";
      errorDetails = "ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
    } else if (error.message?.includes("API_KEY") || error.message?.includes("api key")) {
      errorMessage = "APIã‚­ãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“";
      errorDetails = "ã‚µãƒ¼ãƒãƒ¼ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚";
    }
    
    console.error("è¿”å´ã™ã‚‹ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹:", { error: errorMessage, details: errorDetails, status: error.status || 500 });
    console.error("=====================================");
    
    return NextResponse.json({ 
      error: errorMessage, 
      details: errorDetails
    }, { status: error.status || 500 });
  }
}
