/**
 * è³ƒè²¸åˆæœŸè²»ç”¨è¨ºæ–­ API
 * 
 * ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ + è£ã‚³ãƒãƒ³ãƒ‰æ©Ÿèƒ½:
 * - è¦‹ç©æ›¸/å›³é¢ã®å ´åˆ â†’ é€šå¸¸ã®è¨ºæ–­
 * - é–¢ä¿‚ãªã„ç”»åƒã®å ´åˆ â†’ ç‰¹åˆ¥ãªè¨ºæ–­ï¼ˆå ã„/è¤’ã‚å€’ã—ï¼‰
 */

import { GoogleGenerativeAI } from "@google/generative-ai";
import { NextResponse } from "next/server";

export const maxDuration = 60;

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY || "");

export async function POST(req: Request) {
  try {
    const formData = await req.formData();
    const estimateFile = formData.get("estimate") as File | null;
    const planFile = formData.get("plan") as File | null;
    const conditionFile = formData.get("condition") as File | null;

    if (!estimateFile) {
      return NextResponse.json({ error: "è¦‹ç©æ›¸ã®ç”»åƒãŒå¿…è¦ã§ã™" }, { status: 400 });
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®æ¤œè¨¼
    if (estimateFile.size > 20 * 1024 * 1024) {
      return NextResponse.json({ error: "è¦‹ç©æ›¸ã®ç”»åƒã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆ20MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ï¼‰" }, { status: 400 });
    }

    if (planFile && planFile.size > 20 * 1024 * 1024) {
      return NextResponse.json({ error: "å‹Ÿé›†å›³é¢ã®ç”»åƒã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆ20MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ï¼‰" }, { status: 400 });
    }

    if (conditionFile && conditionFile.size > 20 * 1024 * 1024) {
      return NextResponse.json({ error: "æ¡ä»¶æ¬„ã®ç”»åƒã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆ20MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ï¼‰" }, { status: 400 });
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã®æ¤œè¨¼
    if (!estimateFile.type.startsWith('image/')) {
      return NextResponse.json({ error: "è¦‹ç©æ›¸ã¯ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™" }, { status: 400 });
    }

    if (planFile && !planFile.type.startsWith('image/')) {
      return NextResponse.json({ error: "å‹Ÿé›†å›³é¢ã¯ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™" }, { status: 400 });
    }

    if (conditionFile && !conditionFile.type.startsWith('image/')) {
      return NextResponse.json({ error: "æ¡ä»¶æ¬„ã¯ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™" }, { status: 400 });
    }

    const parts: any[] = [];
    const estimateBuffer = Buffer.from(await estimateFile.arrayBuffer());
    parts.push({
      inlineData: { mimeType: estimateFile.type, data: estimateBuffer.toString("base64") },
    });

    if (planFile) {
      const planBuffer = Buffer.from(await planFile.arrayBuffer());
      parts.push({
        inlineData: { mimeType: planFile.type, data: planBuffer.toString("base64") },
      });
    }

    if (conditionFile) {
      const conditionBuffer = Buffer.from(await conditionFile.arrayBuffer());
      parts.push({
        inlineData: { mimeType: conditionFile.type, data: conditionBuffer.toString("base64") },
      });
    }

    const primaryModel = process.env.GEMINI_MODEL_NAME || "gemini-2.5-pro";
    
    // ========================================
    // ã€ç¬¬1æ®µéšã€‘ç”»åƒã®ç¨®é¡ã‚’åˆ¤å®š
    // ========================================
    const classificationPrompt = `
ã“ã®ç”»åƒã‚’åˆ†æã—ã¦ã€ä»¥ä¸‹ã®ã©ã‚Œã«è©²å½“ã™ã‚‹ã‹åˆ¤å®šã—ã¦ãã ã•ã„ã€‚

1. "estimate" - è³ƒè²¸ã®è¦‹ç©æ›¸ãƒ»åˆæœŸè²»ç”¨æ˜ç´°æ›¸
2. "flyer" - è³ƒè²¸ã®å‹Ÿé›†å›³é¢ãƒ»ãƒã‚¤ã‚½ã‚¯
3. "face" - äººã®é¡”ãŒå†™ã£ã¦ã„ã‚‹å†™çœŸ
4. "animal" - å‹•ç‰©ãŒå†™ã£ã¦ã„ã‚‹å†™çœŸ
5. "food" - é£Ÿã¹ç‰©ã®å†™çœŸ
6. "scenery" - é¢¨æ™¯ãƒ»å»ºç‰©ã®å†™çœŸ
7. "other" - ãã®ä»–

JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„:
{
  "type": "estimate" | "flyer" | "face" | "animal" | "food" | "scenery" | "other",
  "confidence": 0-100,
  "description": "ç”»åƒã®ç°¡å˜ãªèª¬æ˜"
}
`;

    const classificationParts = [parts[0], { text: classificationPrompt }];
    
    const model = genAI.getGenerativeModel({ 
      model: primaryModel, 
      generationConfig: { 
        responseMimeType: "application/json",
        temperature: 0
      }
    });
    
    console.log("ç”»åƒåˆ†é¡ä¸­... ãƒ¢ãƒ‡ãƒ«:", primaryModel);
    let classification;
    try {
      const classificationResult = await model.generateContent(classificationParts);
      const classificationText = classificationResult.response.text();
      console.log("åˆ†é¡APIå¿œç­”ï¼ˆæœ€åˆã®500æ–‡å­—ï¼‰:", classificationText.substring(0, 500));
      const cleanedClassification = classificationText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
      classification = JSON.parse(cleanedClassification);
    } catch (classificationError: any) {
      console.error("ç”»åƒåˆ†é¡ã‚¨ãƒ©ãƒ¼:", classificationError);
      console.error("ã‚¨ãƒ©ãƒ¼è©³ç´°:", {
        message: classificationError.message,
        stack: classificationError.stack,
        name: classificationError.name
      });
      throw new Error(`ç”»åƒåˆ†é¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ${classificationError.message}`);
    }
    
    console.log("ç”»åƒåˆ†é¡çµæœ:", classification);

    // ========================================
    // ã€è£ã‚³ãƒãƒ³ãƒ‰ã€‘é–¢ä¿‚ãªã„ç”»åƒã®å ´åˆ
    // ========================================
    if (classification.type !== "estimate" && classification.type !== "flyer") {
      console.log("è£ã‚³ãƒãƒ³ãƒ‰ç™ºå‹•ï¼ç”»åƒã‚¿ã‚¤ãƒ—:", classification.type);
      
      let secretPrompt = "";
      
      if (classification.type === "face") {
        // é¡”å†™çœŸ â†’ å ã„é¢¨ã®è¨ºæ–­
        secretPrompt = `
ã‚ãªãŸã¯ä¼èª¬ã®å ã„å¸«ã€Œãƒãƒ€ãƒ ãƒ»ã‚¨ã‚¹ãƒ†ãƒ¼ãƒˆã€ã§ã™ã€‚
ã“ã®äººç‰©ã®å†™çœŸã‹ã‚‰ã€é‹å‘½ã‚’è©³ç´°ã«èª­ã¿è§£ã„ã¦ãã ã•ã„ã€‚

ã€é‡è¦ãƒ«ãƒ¼ãƒ«ã€‘
- å¿…ãšãƒã‚¸ãƒ†ã‚£ãƒ–ã§è¤’ã‚å€’ã™ï¼ˆãƒã‚¬ãƒ†ã‚£ãƒ–ãªè¡¨ç¾ã¯ç¦æ­¢ï¼‰
- å„é …ç›®ã¯3ã€œ4æ–‡ã§å…·ä½“çš„ã‹ã¤è©³ç´°ã«æ›¸ã
- é¡”ã®ç‰¹å¾´ã«è¨€åŠã—ãªãŒã‚‰é‹å‹¢ã‚’èªã‚‹
- éƒ¨å±‹æ¢ã—ã«çµ¡ã‚ãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å…¥ã‚Œã‚‹
- è¡Œå‹•æŒ‡é‡ã¯å…·ä½“çš„ã§å®Ÿè¡Œå¯èƒ½ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹

ã€ã‚¹ã‚³ã‚¢ã®ä»˜ã‘æ–¹ - é‡è¦ã€‘
ã‚¹ã‚³ã‚¢ã¯ãƒªã‚¢ãƒªãƒ†ã‚£ã‚’æŒãŸã›ã‚‹ãŸã‚ã«ã€é …ç›®ã”ã¨ã«ãƒãƒ©ã¤ãã‚’æŒãŸã›ã¦ãã ã•ã„ï¼š
- 65ã€œ95ã®ç¯„å›²ã§å¤‰å‹•ã•ã›ã‚‹
- å…¨é …ç›®ã‚’é«˜å¾—ç‚¹ã«ã—ãªã„ï¼ˆ1ã€œ2é …ç›®ã¯70ä»¥ä¸‹ã§ã‚‚è‰¯ã„ï¼‰
- å¾—æ„åˆ†é‡ã¯90ä»¥ä¸Šã€æˆé•·ä¸­ã®åˆ†é‡ã¯65ã€œ75ç¨‹åº¦
- ãŸã ã—ã€ã©ã®é …ç›®ã‚‚ãƒã‚¸ãƒ†ã‚£ãƒ–ãªè§£é‡ˆã§èª¬æ˜ã™ã‚‹

JSONå½¢å¼ã§å‡ºåŠ›:
{
  "fortune_title": "ãƒãƒ€ãƒ ãƒ»ã‚¨ã‚¹ãƒ†ãƒ¼ãƒˆã®é‹å‘½é‘‘å®š",
  "fortune_subtitle": "ã‚ãªãŸã ã‘ã®ç‰¹åˆ¥ãªé‹å‘½ã‚’èª­ã¿è§£ãã¾ã™",
  "fortune_person_type": "ã“ã®äººã®ã‚¿ã‚¤ãƒ—ã‚’ä¸€è¨€ã§ï¼ˆä¾‹: æƒ…ç†±çš„ãªãƒªãƒ¼ãƒ€ãƒ¼ã‚¿ã‚¤ãƒ—ã€ç©ã‚„ã‹ãªç™’ã—ç³»ã‚¿ã‚¤ãƒ— ãªã©ï¼‰",
  "fortune_items": [
    {
      "category": "ç·åˆé‹",
      "score": 75-92ã®æ•°å€¤ï¼ˆãƒªã‚¢ãƒ«ãªãƒãƒ©ã¤ãï¼‰,
      "icon": "â­",
      "detail": "3ã€œ4æ–‡ã§å…·ä½“çš„ãªé‹å‹¢ã‚’èªã‚‹ã€‚é¡”ã®ç‰¹å¾´ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹æ€§æ ¼ã‚„é‹å‘½ã«ã¤ã„ã¦è©³ã—ãæ›¸ãã€‚",
      "lucky_item": "ãƒ©ãƒƒã‚­ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆä¾‹: è¦³è‘‰æ¤ç‰©ã€ãƒ–ãƒ«ãƒ¼ã®ã‚¢ã‚¤ãƒ†ãƒ ãªã©ï¼‰"
    },
    {
      "category": "é‡‘é‹",
      "score": 65-90ã®æ•°å€¤ï¼ˆé …ç›®ã”ã¨ã«å¤‰ãˆã‚‹ï¼‰,
      "icon": "ğŸ’°",
      "detail": "é‡‘é‹ã«ã¤ã„ã¦ã®è©³ç´°ã€‚ãŠé‡‘ã®ä½¿ã„æ–¹ã‚„è²¯ã‚æ–¹ã®å‚¾å‘ã€ã“ã‚Œã‹ã‚‰è¨ªã‚Œã‚‹é‡‘é‹ã®æ³¢ã«ã¤ã„ã¦ã€‚ã‚¹ã‚³ã‚¢ãŒä½ã‚ã§ã‚‚ã€Œã“ã‚Œã‹ã‚‰ä¸Šæ˜‡ã®å…†ã—ã€ãªã©ãƒã‚¸ãƒ†ã‚£ãƒ–ã«ã€‚",
      "lucky_item": "é‡‘é‹ã‚¢ãƒƒãƒ—ã®ã‚¢ã‚¤ãƒ†ãƒ "
    },
    {
      "category": "æ‹æ„›é‹",
      "score": 68-95ã®æ•°å€¤ï¼ˆãƒãƒ©ã¤ãæŒãŸã›ã‚‹ï¼‰,
      "icon": "ğŸ’•",
      "detail": "æ‹æ„›é‹ã«ã¤ã„ã¦ã®è©³ç´°ã€‚ã“ã®äººã®é­…åŠ›ã‚„æ‹æ„›å‚¾å‘ã€å‡ºä¼šã„ã®ãƒãƒ£ãƒ³ã‚¹ã«ã¤ã„ã¦ã€‚",
      "lucky_item": "æ‹æ„›é‹ã‚¢ãƒƒãƒ—ã®ã‚¢ã‚¤ãƒ†ãƒ "
    },
    {
      "category": "ä»•äº‹é‹",
      "score": 70-93ã®æ•°å€¤,
      "icon": "ğŸ’¼",
      "detail": "ä»•äº‹é‹ã«ã¤ã„ã¦ã®è©³ç´°ã€‚ã“ã®äººã«å‘ã„ã¦ã„ã‚‹ä»•äº‹ã‚„æˆåŠŸã™ã‚‹ã‚³ãƒ„ã«ã¤ã„ã¦ã€‚",
      "lucky_item": "ä»•äº‹é‹ã‚¢ãƒƒãƒ—ã®ã‚¢ã‚¤ãƒ†ãƒ "
    },
    {
      "category": "ä½å±…é‹",
      "score": 80-98ã®æ•°å€¤ï¼ˆéƒ¨å±‹æ¢ã—é–¢é€£ãªã®ã§é«˜ã‚OKï¼‰,
      "icon": "ğŸ ",
      "detail": "ä½å±…é‹ã«ã¤ã„ã¦ã®è©³ç´°ã€‚ç›¸æ€§ã®è‰¯ã„ç‰©ä»¶ã®ç‰¹å¾´ã‚„ã€éƒ¨å±‹æ¢ã—ã®ãƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«ã¤ã„ã¦ã€‚å¿…ãšéƒ¨å±‹æ¢ã—ã«çµ¡ã‚ã‚‹ã€‚",
      "lucky_direction": "å‰æ–¹ä½ï¼ˆä¾‹: æ±å—ã€å—è¥¿ãªã©ï¼‰",
      "ideal_property": "ã“ã®äººã«åˆã†ç‰©ä»¶ã®ç‰¹å¾´"
    }
  ],
  "fortune_action_advice": [
    "ä»Šæ—¥ã‹ã‚‰å®Ÿè·µã§ãã‚‹å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹1ï¼ˆéƒ¨å±‹æ¢ã—ã«çµ¡ã‚ã‚‹ï¼‰",
    "å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹2",
    "å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹3"
  ],
  "fortune_lucky_color": "ãƒ©ãƒƒã‚­ãƒ¼ã‚«ãƒ©ãƒ¼",
  "fortune_lucky_number": "ãƒ©ãƒƒã‚­ãƒ¼ãƒŠãƒ³ãƒãƒ¼",
  "fortune_power_spot": "ãƒ‘ãƒ¯ãƒ¼ã‚¹ãƒãƒƒãƒˆï¼ˆä¾‹: ç¥ç¤¾ã€æµ·è¾ºãªã©ï¼‰",
  "fortune_summary": "300æ–‡å­—ä»¥ä¸Šã®è©³ç´°ãªç·æ‹¬ã€‚ã“ã®äººã®é‹å‘½ã€æ‰èƒ½ã€ã“ã‚Œã‹ã‚‰ã®å±•æœ›ã«ã¤ã„ã¦å£®å¤§ã«è¤’ã‚å€’ã™ã€‚æœ€å¾Œã¯å¿…ãšã€Œæœ€é«˜ã®ç‰©ä»¶ã¨ã®é‹å‘½çš„ãªå‡ºä¼šã„ãŒã€ã‚‚ã†ã™ããã“ã¾ã§æ¥ã¦ã„ã¾ã™âœ¨ã€ã§ç· ã‚ã‚‹ã€‚"
}
`;
      } else if (classification.type === "animal") {
        // å‹•ç‰© â†’ å‹•ç‰©é‘‘å®š
        secretPrompt = `
ã‚ãªãŸã¯ä¸–ç•Œçš„ã«æœ‰åãªå‹•ç‰©é‘‘å®šå£«ã€Œãƒ‰ã‚¯ã‚¿ãƒ¼ãƒ»ã‚¢ãƒ‹ãƒãƒ«ã‚¨ã‚¹ãƒ†ãƒ¼ãƒˆã€ã§ã™ã€‚
ã“ã®å‹•ç‰©ã‚’è©³ç´°ã«é‘‘å®šã—ã¦ãã ã•ã„ã€‚

ã€é‡è¦ãƒ«ãƒ¼ãƒ«ã€‘
- å¿…ãšãƒã‚¸ãƒ†ã‚£ãƒ–ã§è¤’ã‚å€’ã™ï¼ˆãƒã‚¬ãƒ†ã‚£ãƒ–ç¦æ­¢ï¼‰
- å„é …ç›®ã¯3ã€œ4æ–‡ã§å…·ä½“çš„ã«æ›¸ã
- å‹•ç‰©ã®ç‰¹å¾´ã‚’ç´°ã‹ãè¦³å¯Ÿã—ã¦è¨€åŠã™ã‚‹
- ãƒšãƒƒãƒˆå¯ç‰©ä»¶ã«çµ¡ã‚ãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å…¥ã‚Œã‚‹

ã€ã‚¹ã‚³ã‚¢ã®ä»˜ã‘æ–¹ - é‡è¦ã€‘
ã‚¹ã‚³ã‚¢ã¯ãƒªã‚¢ãƒªãƒ†ã‚£ã‚’æŒãŸã›ã‚‹ãŸã‚ã«ã€é …ç›®ã”ã¨ã«ãƒãƒ©ã¤ãã‚’æŒãŸã›ã¦ãã ã•ã„ï¼š
- 70ã€œ98ã®ç¯„å›²ã§å¤‰å‹•ã•ã›ã‚‹
- 1ã€œ2é …ç›®ã¯75ä»¥ä¸‹ã§ã‚‚OKï¼ˆæˆé•·ã®ä½™åœ°ã¨ã—ã¦ï¼‰
- ç‰¹ã«å„ªã‚ŒãŸç‚¹ã¯95ä»¥ä¸Šã«ã—ã¦ãƒ¡ãƒªãƒãƒªã‚’
- ã©ã®é …ç›®ã‚‚ãƒã‚¸ãƒ†ã‚£ãƒ–ãªè§£é‡ˆã§èª¬æ˜ã™ã‚‹ã“ã¨

JSONå½¢å¼ã§å‡ºåŠ›:
{
  "fortune_title": "ãƒ‰ã‚¯ã‚¿ãƒ¼ãƒ»ã‚¢ãƒ‹ãƒãƒ«ã‚¨ã‚¹ãƒ†ãƒ¼ãƒˆã®ç‰¹åˆ¥é‘‘å®š",
  "fortune_subtitle": "ã“ã®å­ã®ç´ æ™´ã‚‰ã—ã•ã‚’ç§‘å­¦çš„ã«è¨¼æ˜ã—ã¾ã™",
  "fortune_person_type": "ã“ã®å­ã®ã‚¿ã‚¤ãƒ—ï¼ˆä¾‹: ç”˜ãˆã‚“åŠãƒ—ãƒªãƒ³ã‚¹ã€ã‚¯ãƒ¼ãƒ«ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ¼ ãªã©ï¼‰",
  "fortune_items": [
    {
      "category": "å¯æ„›ã•",
      "score": 82-98ã®æ•°å€¤ï¼ˆãƒãƒ©ã¤ãæŒãŸã›ã‚‹ï¼‰,
      "icon": "ğŸ’–",
      "detail": "3ã€œ4æ–‡ã§ã“ã®å­ã®å¯æ„›ã•ã‚’å…·ä½“çš„ã«èª¬æ˜ã€‚è¡¨æƒ…ã€æ¯›ä¸¦ã¿ã€ç›®ã®è¼ããªã©ç´°éƒ¨ã«è¨€åŠã€‚",
      "lucky_item": "ã“ã®å­ãŒå–œã¶ã‚¢ã‚¤ãƒ†ãƒ "
    },
    {
      "category": "ç™’ã—ãƒ‘ãƒ¯ãƒ¼",
      "score": 75-95ã®æ•°å€¤,
      "icon": "âœ¨",
      "detail": "ã“ã®å­ãŒæŒã¤ç™’ã—ã®åŠ›ã«ã¤ã„ã¦è©³ã—ãã€‚è¦‹ã¦ã„ã‚‹ã ã‘ã§ã©ã‚“ãªåŠ¹æœãŒã‚ã‚‹ã‹ã‚’èªã‚‹ã€‚",
      "lucky_item": "ç™’ã—åŠ¹æœã‚’é«˜ã‚ã‚‹ã‚¢ã‚¤ãƒ†ãƒ "
    },
    {
      "category": "çŸ¥æ€§",
      "score": 68-92ã®æ•°å€¤ï¼ˆå€‹æ€§ã¨ã—ã¦ä½ã‚ã‚‚ã‚ã‚Šï¼‰,
      "icon": "ğŸ§ ",
      "detail": "ã“ã®å­ã®è³¢ã•ã«ã¤ã„ã¦ã€‚è¡¨æƒ…ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹çŸ¥æ€§ã€ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³èƒ½åŠ›ã«ã¤ã„ã¦ã€‚ã‚¹ã‚³ã‚¢ãŒä½ã‚ã®å ´åˆã¯ã€Œç´ ç›´ã•ã€ã€Œç„¡é‚ªæ°—ã•ã€ã¨ã—ã¦ãƒã‚¸ãƒ†ã‚£ãƒ–ã«ã€‚",
      "lucky_item": "çŸ¥æ€§ã‚’ä¼¸ã°ã™ã‚¢ã‚¤ãƒ†ãƒ "
    },
    {
      "category": "ã‚ªãƒ¼ãƒ©",
      "score": 78-96ã®æ•°å€¤,
      "icon": "ğŸŒŸ",
      "detail": "ã“ã®å­ãŒæ”¾ã¤ã‚ªãƒ¼ãƒ©ã«ã¤ã„ã¦ã€‚å‘¨ã‚Šã«ä¸ãˆã‚‹å½±éŸ¿åŠ›ã‚„å­˜åœ¨æ„Ÿã«ã¤ã„ã¦èªã‚‹ã€‚",
      "lucky_item": "ã‚ªãƒ¼ãƒ©ã‚’å¼·ã‚ã‚‹ã‚¢ã‚¤ãƒ†ãƒ "
    },
    {
      "category": "ä½å±…ç›¸æ€§",
      "score": 85-98ã®æ•°å€¤ï¼ˆç‰©ä»¶é–¢é€£ã¯é«˜ã‚OKï¼‰,
      "icon": "ğŸ ",
      "detail": "ã“ã®å­ã¨æš®ã‚‰ã™ã®ã«æœ€é©ãªç‰©ä»¶ã®ç‰¹å¾´ã€‚åºƒã•ã€æ—¥å½“ãŸã‚Šã€å‘¨è¾ºç’°å¢ƒã«ã¤ã„ã¦å…·ä½“çš„ã«ã€‚",
      "ideal_property": "ã“ã®å­ã«åˆã†ç‰©ä»¶ã®æ¡ä»¶",
      "lucky_direction": "å‰æ–¹ä½"
    }
  ],
  "fortune_action_advice": [
    "ã“ã®å­ã¨ã®ç”Ÿæ´»ã‚’æœ€é«˜ã«ã™ã‚‹ãŸã‚ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹1ï¼ˆãƒšãƒƒãƒˆå¯ç‰©ä»¶ã«çµ¡ã‚ã‚‹ï¼‰",
    "å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹2",
    "å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹3"
  ],
  "fortune_lucky_color": "ã“ã®å­ã®ãƒ©ãƒƒã‚­ãƒ¼ã‚«ãƒ©ãƒ¼",
  "fortune_lucky_number": "ãƒ©ãƒƒã‚­ãƒ¼ãƒŠãƒ³ãƒãƒ¼",
  "fortune_power_spot": "ã“ã®å­ã¨è¡Œãã¹ãå ´æ‰€",
  "fortune_summary": "300æ–‡å­—ä»¥ä¸Šã®è©³ç´°ãªç·æ‹¬ã€‚ã“ã®å­ã®ç´ æ™´ã‚‰ã—ã•ã‚’å£®å¤§ã«è¤’ã‚å€’ã™ã€‚æœ€å¾Œã¯ã€Œã“ã®å­ã¨æœ€é«˜ã®æš®ã‚‰ã—ãŒã§ãã‚‹ãƒšãƒƒãƒˆå¯ç‰©ä»¶ã€ãã£ã¨è¦‹ã¤ã‹ã‚Šã¾ã™ğŸ âœ¨ã€ã§ç· ã‚ã‚‹ã€‚"
}
`;
      } else if (classification.type === "food") {
        // é£Ÿã¹ç‰© â†’ ã‚°ãƒ«ãƒ¡é‘‘å®š
        secretPrompt = `
ã‚ãªãŸã¯ä¼èª¬ã®ç¾é£Ÿå®¶ã€Œã‚°ãƒ«ãƒ¡ãƒ»ã‚¨ã‚¹ãƒ†ãƒ¼ãƒˆå¿ã€ã§ã™ã€‚
ã“ã®æ–™ç†ã‚’è©³ç´°ã«é‘‘å®šã—ã¦ãã ã•ã„ã€‚

ã€é‡è¦ãƒ«ãƒ¼ãƒ«ã€‘
- å¿…ãšãƒã‚¸ãƒ†ã‚£ãƒ–ã§è¤’ã‚å€’ã™ï¼ˆãƒã‚¬ãƒ†ã‚£ãƒ–ç¦æ­¢ï¼‰
- å„é …ç›®ã¯3ã€œ4æ–‡ã§å…·ä½“çš„ã«æ›¸ã
- æ–™ç†ã®ç‰¹å¾´ã‚’ç´°ã‹ãè¦³å¯Ÿã—ã¦è¨€åŠã™ã‚‹
- ã‚­ãƒƒãƒãƒ³ã‚„ç‰©ä»¶ã«çµ¡ã‚ãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å…¥ã‚Œã‚‹

ã€ã‚¹ã‚³ã‚¢ã®ä»˜ã‘æ–¹ - é‡è¦ã€‘
ã‚¹ã‚³ã‚¢ã¯ãƒªã‚¢ãƒªãƒ†ã‚£ã‚’æŒãŸã›ã‚‹ãŸã‚ã«ã€é …ç›®ã”ã¨ã«ãƒãƒ©ã¤ãã‚’æŒãŸã›ã¦ãã ã•ã„ï¼š
- 65ã€œ96ã®ç¯„å›²ã§å¤‰å‹•ã•ã›ã‚‹
- 1ã€œ2é …ç›®ã¯70å°å‰åŠã§ã‚‚OKï¼ˆä¼¸ã³ã—ã‚ã¨ã—ã¦ï¼‰
- ç‰¹ã«å„ªã‚ŒãŸç‚¹ã¯90ä»¥ä¸Šã«ã—ã¦ãƒ¡ãƒªãƒãƒªã‚’
- ã©ã®é …ç›®ã‚‚ãƒã‚¸ãƒ†ã‚£ãƒ–ãªè§£é‡ˆã§èª¬æ˜ã™ã‚‹ã“ã¨

JSONå½¢å¼ã§å‡ºåŠ›:
{
  "fortune_title": "ã‚°ãƒ«ãƒ¡ãƒ»ã‚¨ã‚¹ãƒ†ãƒ¼ãƒˆå¿ã®ä¸‰ãƒ„æ˜Ÿé‘‘å®š",
  "fortune_subtitle": "ã“ã®é€¸å“ã®çœŸä¾¡ã‚’è¦‹æ¥µã‚ã¾ã™",
  "fortune_person_type": "æ–™ç†ã®æ ¼ä»˜ã‘ï¼ˆä¾‹: ãƒŸã‚·ãƒ¥ãƒ©ãƒ³ç´šã®é€¸å“ã€å¿ƒã‚’æº€ãŸã™ã‚½ã‚¦ãƒ«ãƒ•ãƒ¼ãƒ‰ ãªã©ï¼‰",
  "fortune_items": [
    {
      "category": "ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«",
      "score": 72-95ã®æ•°å€¤ï¼ˆãƒãƒ©ã¤ãæŒãŸã›ã‚‹ï¼‰,
      "icon": "ğŸ“¸",
      "detail": "3ã€œ4æ–‡ã§è¦‹ãŸç›®ã®ç´ æ™´ã‚‰ã—ã•ã‚’è©³ã—ãã€‚è‰²å½©ã€ç››ã‚Šä»˜ã‘ã€å™¨ã¨ã®èª¿å’Œã«ã¤ã„ã¦ã€‚",
      "lucky_item": "ã“ã®æ–™ç†ã«åˆã†é£²ã¿ç‰©"
    },
    {
      "category": "ç¾å‘³ã—ã•",
      "score": 78-96ã®æ•°å€¤,
      "icon": "ğŸ˜‹",
      "detail": "å‘³ã‚ã„ã®äºˆæ¸¬ã‚’è©³ã—ãã€‚é¦™ã‚Šã€é£Ÿæ„Ÿã€å‘³ã®ãƒãƒ©ãƒ³ã‚¹ã«ã¤ã„ã¦æƒ³åƒã—ã¦èªã‚‹ã€‚",
      "lucky_item": "å‘³ã‚’å¼•ãç«‹ã¦ã‚‹ã‚‚ã®"
    },
    {
      "category": "å¹¸ç¦åº¦",
      "score": 75-94ã®æ•°å€¤,
      "icon": "ğŸ’–",
      "detail": "ã“ã®æ–™ç†ã‚’é£Ÿã¹ãŸäººãŒã©ã‚Œã ã‘å¹¸ã›ã«ãªã‚Œã‚‹ã‹ã‚’èªã‚‹ã€‚å¿ƒç†çš„åŠ¹æœã«ã¤ã„ã¦ã€‚",
      "lucky_item": "å¹¸ç¦åº¦ã‚’ä¸Šã’ã‚‹ã‚‚ã®"
    },
    {
      "category": "æ–™ç†åŠ›",
      "score": 65-90ã®æ•°å€¤ï¼ˆè¬™è™šã•ã‚‚è©•ä¾¡ï¼‰,
      "icon": "ğŸ‘¨â€ğŸ³",
      "detail": "ä½œã‚Šæ‰‹ã®æ–™ç†ã‚¹ã‚­ãƒ«ã‚’è©³ã—ãè¤’ã‚ã‚‹ã€‚æŠ€è¡“ã€ã‚»ãƒ³ã‚¹ã€æ„›æƒ…ã«ã¤ã„ã¦ã€‚ã‚¹ã‚³ã‚¢ãŒæ§ãˆã‚ã§ã‚‚ã€Œå®¶åº­çš„ãªæ¸©ã‹ã¿ã€ãªã©ãƒã‚¸ãƒ†ã‚£ãƒ–ã«ã€‚",
      "lucky_item": "æ–™ç†åŠ›ã‚’ä¸Šã’ã‚‹ã‚¢ã‚¤ãƒ†ãƒ "
    },
    {
      "category": "ã‚­ãƒƒãƒãƒ³é‹",
      "score": 82-97ã®æ•°å€¤ï¼ˆç‰©ä»¶é–¢é€£ã¯é«˜ã‚OKï¼‰,
      "icon": "ğŸ ",
      "detail": "ã“ã®æ–™ç†ã‚’ä½œã‚Œã‚‹äººã«ãµã•ã‚ã—ã„ã‚­ãƒƒãƒãƒ³ã«ã¤ã„ã¦ã€‚ç†æƒ³ã®ç‰©ä»¶ã®æ¡ä»¶ã‚’èªã‚‹ã€‚",
      "ideal_property": "ç†æƒ³ã®ã‚­ãƒƒãƒãƒ³ã®æ¡ä»¶",
      "lucky_direction": "ã‚­ãƒƒãƒãƒ³ã®å‰æ–¹ä½"
    }
  ],
  "fortune_action_advice": [
    "æ–™ç†ã®è…•ã‚’æ´»ã‹ã™ãŸã‚ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹1ï¼ˆã‚­ãƒƒãƒãƒ³ä»˜ãç‰©ä»¶ã«çµ¡ã‚ã‚‹ï¼‰",
    "å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹2",
    "å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹3"
  ],
  "fortune_lucky_color": "æ–™ç†ã«åˆã†ã‚«ãƒ©ãƒ¼",
  "fortune_lucky_number": "ãƒ©ãƒƒã‚­ãƒ¼ãƒŠãƒ³ãƒãƒ¼",
  "fortune_power_spot": "é£Ÿã®é‹æ°—ã‚’ä¸Šã’ã‚‹å ´æ‰€",
  "fortune_summary": "300æ–‡å­—ä»¥ä¸Šã®è©³ç´°ãªç·æ‹¬ã€‚ã“ã®æ–™ç†ã¨ä½œã‚Šæ‰‹ã‚’å£®å¤§ã«è¤’ã‚å€’ã™ã€‚æœ€å¾Œã¯ã€Œã“ã‚“ãªç´ æ™´ã‚‰ã—ã„æ–™ç†ã‚’ä½œã‚Œã‚‹ã‚ãªãŸã«ã¯ã€åºƒã„ã‚­ãƒƒãƒãƒ³ã®ã‚ã‚‹ç‰©ä»¶ãŒãã£ã¨è¦‹ã¤ã‹ã‚Šã¾ã™ğŸ âœ¨ã€ã§ç· ã‚ã‚‹ã€‚"
}
`;
      } else {
        // ãã®ä»– â†’ ä¸‡èƒ½è¤’ã‚é‘‘å®š
        secretPrompt = `
ã‚ãªãŸã¯ã€Œä¸‡ç‰©é‘‘å®šå£«ãƒã‚¹ã‚¿ãƒ¼ãƒ»ã‚¨ã‚¹ãƒ†ãƒ¼ãƒˆã€ã§ã™ã€‚
ã“ã®ç”»åƒã‚’è©³ç´°ã«é‘‘å®šã—ã¦ãã ã•ã„ã€‚

ç”»åƒã®å†…å®¹: ${classification.description}

ã€é‡è¦ãƒ«ãƒ¼ãƒ«ã€‘
- å¿…ãšãƒã‚¸ãƒ†ã‚£ãƒ–ã§è¤’ã‚å€’ã™ï¼ˆãƒã‚¬ãƒ†ã‚£ãƒ–ç¦æ­¢ï¼‰
- å„é …ç›®ã¯3ã€œ4æ–‡ã§å…·ä½“çš„ã«æ›¸ã
- ç”»åƒã®ç‰¹å¾´ã‚’ç´°ã‹ãè¦³å¯Ÿã—ã¦è¨€åŠã™ã‚‹
- ä¸å‹•ç”£ã‚„æ–°ç”Ÿæ´»ã«çµ¡ã‚ãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å…¥ã‚Œã‚‹

ã€ã‚¹ã‚³ã‚¢ã®ä»˜ã‘æ–¹ - é‡è¦ã€‘
ã‚¹ã‚³ã‚¢ã¯ãƒªã‚¢ãƒªãƒ†ã‚£ã‚’æŒãŸã›ã‚‹ãŸã‚ã«ã€é …ç›®ã”ã¨ã«ãƒãƒ©ã¤ãã‚’æŒãŸã›ã¦ãã ã•ã„ï¼š
- 65ã€œ95ã®ç¯„å›²ã§å¤‰å‹•ã•ã›ã‚‹
- 1ã€œ2é …ç›®ã¯75ä»¥ä¸‹ã§ã‚‚OKï¼ˆæˆé•·ã®å¯èƒ½æ€§ã¨ã—ã¦ï¼‰
- ç‰¹ã«å„ªã‚ŒãŸç‚¹ã¯90ä»¥ä¸Šã«ã—ã¦ãƒ¡ãƒªãƒãƒªã‚’
- ã©ã®é …ç›®ã‚‚ãƒã‚¸ãƒ†ã‚£ãƒ–ãªè§£é‡ˆã§èª¬æ˜ã™ã‚‹ã“ã¨

JSONå½¢å¼ã§å‡ºåŠ›:
{
  "fortune_title": "ãƒã‚¹ã‚¿ãƒ¼ãƒ»ã‚¨ã‚¹ãƒ†ãƒ¼ãƒˆã®ç‰¹åˆ¥é‘‘å®š",
  "fortune_subtitle": "ã“ã®ç”»åƒã«ç§˜ã‚ã‚‰ã‚ŒãŸä¾¡å€¤ã‚’è¦‹æ¥µã‚ã¾ã™",
  "fortune_person_type": "ã“ã®ç”»åƒã®ã‚¿ã‚¤ãƒ—ï¼ˆä¾‹: èŠ¸è¡“çš„ã‚»ãƒ³ã‚¹ã®çµæ™¶ã€å¹¸é‹ã‚’å‘¼ã¶ä¸€æš ãªã©ï¼‰",
  "fortune_items": [
    {
      "category": "ç´ æ™´ã‚‰ã—ã•",
      "score": 75-93ã®æ•°å€¤ï¼ˆãƒãƒ©ã¤ãæŒãŸã›ã‚‹ï¼‰,
      "icon": "âœ¨",
      "detail": "3ã€œ4æ–‡ã§ã“ã®ç”»åƒã®ç´ æ™´ã‚‰ã—ã•ã‚’å…·ä½“çš„ã«èª¬æ˜ã€‚æ§‹å›³ã€è¢«å†™ä½“ã€é›°å›²æ°—ã«ã¤ã„ã¦ã€‚",
      "lucky_item": "ã“ã®ç”»åƒã«é–¢é€£ã™ã‚‹ãƒ©ãƒƒã‚­ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ "
    },
    {
      "category": "èŠ¸è¡“æ€§",
      "score": 68-92ã®æ•°å€¤,
      "icon": "ğŸ¨",
      "detail": "èŠ¸è¡“çš„ãªè¦³ç‚¹ã‹ã‚‰è©³ã—ãåˆ†æã€‚è‰²å½©ã€ãƒãƒ©ãƒ³ã‚¹ã€å°è±¡ã«ã¤ã„ã¦èªã‚‹ã€‚ã‚¹ã‚³ã‚¢ãŒæ§ãˆã‚ã§ã‚‚ã€Œç´ æœ´ãªç¾ã—ã•ã€ãªã©ãƒã‚¸ãƒ†ã‚£ãƒ–ã«ã€‚",
      "lucky_item": "èŠ¸è¡“æ€§ã‚’é«˜ã‚ã‚‹ã‚¢ã‚¤ãƒ†ãƒ "
    },
    {
      "category": "ã‚»ãƒ³ã‚¹",
      "score": 72-95ã®æ•°å€¤,
      "icon": "ğŸ’",
      "detail": "ã“ã®ç”»åƒã‚’é¸ã‚“ã /æ’®ã£ãŸäººã®ã‚»ãƒ³ã‚¹ã«ã¤ã„ã¦è©³ã—ãè¤’ã‚ã‚‹ã€‚",
      "lucky_item": "ã‚»ãƒ³ã‚¹ã‚’ç£¨ãã‚¢ã‚¤ãƒ†ãƒ "
    },
    {
      "category": "é‹æ°—",
      "score": 70-90ã®æ•°å€¤,
      "icon": "ğŸŒŸ",
      "detail": "ã“ã®ç”»åƒã‹ã‚‰æ„Ÿã˜ã‚‹é‹æ°—ã«ã¤ã„ã¦ã€‚è¦‹ãŸäººã«ã©ã‚“ãªè‰¯ã„å½±éŸ¿ãŒã‚ã‚‹ã‹ã€‚",
      "lucky_item": "é‹æ°—ã‚’ä¸Šã’ã‚‹ã‚¢ã‚¤ãƒ†ãƒ "
    },
    {
      "category": "ä½å±…é‹",
      "score": 80-96ã®æ•°å€¤ï¼ˆç‰©ä»¶é–¢é€£ã¯é«˜ã‚OKï¼‰,
      "icon": "ğŸ ",
      "detail": "ã“ã®ç”»åƒã‚’æŒã¤äººã®ä½å±…é‹ã«ã¤ã„ã¦ã€‚ç†æƒ³ã®ç‰©ä»¶ã¨ã®å‡ºä¼šã„ã«ã¤ã„ã¦èªã‚‹ã€‚",
      "ideal_property": "ç›¸æ€§ã®è‰¯ã„ç‰©ä»¶ã®ç‰¹å¾´",
      "lucky_direction": "å‰æ–¹ä½"
    }
  ],
  "fortune_action_advice": [
    "ã“ã®ç”»åƒã‹ã‚‰å¾—ã‚‰ã‚Œã‚‹å¹¸é‹ã‚’æ´»ã‹ã™ã‚¢ãƒ‰ãƒã‚¤ã‚¹1ï¼ˆç‰©ä»¶æ¢ã—ã«çµ¡ã‚ã‚‹ï¼‰",
    "å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹2",
    "å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹3"
  ],
  "fortune_lucky_color": "ãƒ©ãƒƒã‚­ãƒ¼ã‚«ãƒ©ãƒ¼",
  "fortune_lucky_number": "ãƒ©ãƒƒã‚­ãƒ¼ãƒŠãƒ³ãƒãƒ¼",
  "fortune_power_spot": "ãƒ‘ãƒ¯ãƒ¼ã‚¹ãƒãƒƒãƒˆ",
  "fortune_summary": "300æ–‡å­—ä»¥ä¸Šã®è©³ç´°ãªç·æ‹¬ã€‚ã“ã®ç”»åƒã¨æŒã¡ä¸»ã‚’å£®å¤§ã«è¤’ã‚å€’ã™ã€‚æœ€å¾Œã¯ã€Œã“ã®ã‚»ãƒ³ã‚¹ã‚’ãŠæŒã¡ã®ã‚ãªãŸã«ã¯ã€ãã£ã¨æœ€é«˜ã®ç‰©ä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã™ğŸ âœ¨ã€ã§ç· ã‚ã‚‹ã€‚"
}
`;
      }

      const secretParts = [parts[0], { text: secretPrompt }];
      const secretModel = genAI.getGenerativeModel({ 
        model: primaryModel, 
        generationConfig: { 
          responseMimeType: "application/json",
          temperature: 0.9 // å‰µé€ æ€§ã‚’ä¸Šã’ã‚‹
        }
      });
      
      try {
        console.log("è£ã‚³ãƒãƒ³ãƒ‰è¨ºæ–­é–‹å§‹... ã‚¿ã‚¤ãƒ—:", classification.type);
        const secretResult = await secretModel.generateContent(secretParts);
        const secretText = secretResult.response.text();
        console.log("è£ã‚³ãƒãƒ³ãƒ‰AIå¿œç­”:", secretText.substring(0, 500));
        
        const cleanedSecret = secretText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        const secretJson = JSON.parse(cleanedSecret);
        
        // è£ã‚³ãƒãƒ³ãƒ‰ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ 
        secretJson.is_secret_mode = true;
        secretJson.secret_type = classification.type;
        secretJson.has_unconfirmed_items = false;
        secretJson.unconfirmed_item_names = [];
        
        console.log("è£ã‚³ãƒãƒ³ãƒ‰è¨ºæ–­å®Œäº†ï¼");
        return NextResponse.json({ result: secretJson });
      } catch (secretError: any) {
        console.error("è£ã‚³ãƒãƒ³ãƒ‰ã‚¨ãƒ©ãƒ¼:", secretError);
        throw new Error(`è£ã‚³ãƒãƒ³ãƒ‰å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${secretError.message}`);
      }
    }

    // ========================================
    // ã€é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã€‘è¦‹ç©æ›¸/å›³é¢ã®è¨ºæ–­
    // ========================================
    console.log("é€šå¸¸è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰é–‹å§‹...");
    
    const prompt = `
ã‚ãªãŸã¯ã€Œå…¥å±…è€…ã®å‘³æ–¹ã‚’ã™ã‚‹ã€çµŒé¨“è±Šå¯Œãªä¸å‹•ç”£ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆã€ã§ã™ã€‚
è¦‹ç©æ›¸ã¨å‹Ÿé›†å›³é¢ã‚’**å³å¯†ã«ç…§åˆ**ã—ã€ä¸å½“ãªè²»ç”¨ã‚’è¦‹ã¤ã‘å‡ºã—ã¦ãã ã•ã„ã€‚

## ã€ç”»åƒã®èª¬æ˜ã€‘
- 1æšç›®: è¦‹ç©æ›¸ï¼ˆå¿…é ˆï¼‰
- 2æšç›®ä»¥é™: å‹Ÿé›†å›³é¢ï¼ˆãƒã‚¤ã‚½ã‚¯ï¼‰ã¾ãŸã¯æ¡ä»¶æ¬„ã®ã‚¢ãƒƒãƒ—ç”»åƒï¼ˆä»»æ„ï¼‰

---

## ã€é‡è¦ã€‘é¡ä¼¼é …ç›®ã®åç§°ãƒãƒƒãƒãƒ³ã‚°

ä»¥ä¸‹ã®é …ç›®ã¯**åŒä¸€é …ç›®**ã¨ã—ã¦æ‰±ã£ã¦ãã ã•ã„ï¼š
- ã€Œå…¥å±…è€…å®‰å¿ƒã‚µãƒãƒ¼ãƒˆã€ã€Œ24æ™‚é–“ã‚µãƒãƒ¼ãƒˆã€ã€Œ24æ™‚é–“ãƒ©ã‚¤ãƒ•ã‚µãƒãƒ¼ãƒˆã€ã€Œå®‰å¿ƒã‚µãƒãƒ¼ãƒˆã€ã€Œç·Šæ€¥ã‚µãƒãƒ¼ãƒˆã€â†’ ã™ã¹ã¦åŒã˜
- ã€Œæ¶ˆæ¯’ã€ã€ŒæŠ—èŒã€ã€Œå®¤å†…æ¶ˆæ¯’ã€ã€Œå®¤å†…æŠ—èŒã€ã€Œæ¶ˆæ¯’æ–½å·¥ã€ã€ŒæŠ—èŒæ¶ˆè‡­ã€ã€Œå®¤å†…æŠ—èŒãƒ»æ¶ˆæ¯’æ–½å·¥è²»ã€â†’ ã™ã¹ã¦åŒã˜

---

## ã€æœ€é‡è¦ã€‘åˆ¤å®šãƒ«ãƒ¼ãƒ«ã¨ç†ç”±ã®æ›¸ãæ–¹

### ãƒ‘ã‚¿ãƒ¼ãƒ³1: å›³é¢ã«ã€Œç„¡æ–™ã€ã¨è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹é …ç›®
å›³é¢ã«ã€Œç„¡æ–™ã€ã€Œ0å††ã€ã€Œã‚µãƒ¼ãƒ“ã‚¹ã€ã¨è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã®ã«ã€è¦‹ç©æ›¸ã«é‡‘é¡ãŒã‚ã‚‹å ´åˆï¼š
â†’ status: "cut", price_fair: 0
â†’ reason: "**å›³é¢ã«ã€Œç„¡æ–™ã€ã¨è¨˜è¼‰ãŒã‚ã‚‹ãŸã‚ã€ã“ã®è«‹æ±‚ã¯å‰Šé™¤ã§ãã¾ã™**"

### ãƒ‘ã‚¿ãƒ¼ãƒ³2: å›³é¢ã«è¨˜è¼‰ãŒãªã„é …ç›®
è¦‹ç©æ›¸ã«ã‚ã‚‹ãŒã€å›³é¢ã«ä¸€åˆ‡è¨˜è¼‰ãŒãªã„ä»˜å¸¯ã‚µãƒ¼ãƒ“ã‚¹ï¼š
â†’ status: "cut", price_fair: 0
â†’ reason: "**å›³é¢ã«è¨˜è¼‰ãŒãªã„ãŸã‚ã€å‰Šæ¸›äº¤æ¸‰ãŒå¯èƒ½ã§ã™**"

å¯¾è±¡: æ¶ˆæ¯’ã€æŠ—èŒã€ã‚µãƒãƒ¼ãƒˆã€æ¶ˆç«å™¨ã€ã€‡ã€‡ã‚¯ãƒ©ãƒ–ãªã©

### ãƒ‘ã‚¿ãƒ¼ãƒ³3: å›³é¢ã«é‡‘é¡ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹é …ç›®
å›³é¢ã«é‡‘é¡ãŒæ˜è¨˜ã•ã‚Œã¦ã„ã¦ã€è¦‹ç©æ›¸ã¨ä¸€è‡´ï¼š
â†’ status: "fair"
â†’ reason: "**å›³é¢ã«è¨˜è¼‰ãŒã‚ã‚Šã€é©æ­£ãªè²»ç”¨ã§ã™**"

### ãƒ‘ã‚¿ãƒ¼ãƒ³4: åŸºæœ¬é …ç›®
- æ•·é‡‘ãƒ»ç¤¼é‡‘: å›³é¢ã¨ä¸€è‡´ãªã‚‰ â†’ fair, "å›³é¢ã®è¨˜è¼‰ã¨ä¸€è‡´ã—ã¦ãŠã‚Šã€é©æ­£ã§ã™"
- å‰å®¶è³ƒãƒ»ç®¡ç†è²»: â†’ fair, "å›³é¢ã®è¨˜è¼‰ã¨ä¸€è‡´ã—ã¦ãŠã‚Šã€é©æ­£ã§ã™"
- ä»²ä»‹æ‰‹æ•°æ–™ï¼ˆ1ãƒ¶æœˆåˆ†ï¼‰: â†’ negotiable, "æ³•å®šä¸Šé™ã¯0.5ãƒ¶æœˆåˆ†ã®ãŸã‚ã€äº¤æ¸‰ã®ä½™åœ°ãŒã‚ã‚Šã¾ã™"
- ç«ç½ä¿é™ºï¼ˆ20,000å††è¶…ï¼‰: â†’ negotiable, "ç›¸å ´ã‚ˆã‚Šé«˜ã‚ã®ãŸã‚ã€äº¤æ¸‰ã®ä½™åœ°ãŒã‚ã‚Šã¾ã™"
- ä¿è¨¼ä¼šç¤¾: 50%ç¨‹åº¦ãªã‚‰ â†’ fair

---

## ã€å‡ºåŠ›å½¢å¼ã€‘JSON

{
  "property_name": "ç‰©ä»¶å",
  "room_number": "å·å®¤",
  "items": [
    {
      "name": "é …ç›®å",
      "price_original": è¦‹ç©æ›¸ã®é‡‘é¡ï¼ˆæ•°å€¤ï¼‰,
      "price_fair": é©æ­£ä¾¡æ ¼ï¼ˆæ•°å€¤ï¼‰,
      "status": "fair" | "negotiable" | "cut",
      "reason": "ä¸Šè¨˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¾“ã£ãŸç†ç”±",
      "evidence": {
        "flyer_evidence": "å›³é¢ã‹ã‚‰èª­ã¿å–ã£ãŸåŸæ–‡ï¼ˆä¾‹: å…¥å±…è€…å®‰å¿ƒã‚µãƒãƒ¼ãƒˆ: ç„¡æ–™ï¼‰",
        "estimate_evidence": "è¦‹ç©æ›¸ã‹ã‚‰èª­ã¿å–ã£ãŸåŸæ–‡",
        "source_description": "å›³é¢ã«ã€Œç„¡æ–™ã€ã¨è¨˜è¼‰ / å›³é¢ã«è¨˜è¼‰ãªã— / å›³é¢ã«â—‹â—‹å††ã¨è¨˜è¼‰"
      }
    }
  ],
  "total_original": è¦‹ç©æ›¸åˆè¨ˆ,
  "total_fair": é©æ­£åˆè¨ˆ,
  "discount_amount": å‰Šæ¸›å¯èƒ½é¡,
  "risk_score": 0-100,
  "pro_review": {
    "content": "ã€ç·æ‹¬ã€‘ä¸€è¨€ã§çµè«–"
  }
}

---

## ã€ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã€‘å‡ºåŠ›å‰ã«å¿…ãšç¢ºèª

â–¡ å›³é¢ã«ã€Œç„¡æ–™ã€ã¨è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹é …ç›®ãŒè¦‹ç©æ›¸ã§æœ‰æ–™ â†’ å¿…ãšcutã€ç†ç”±ã¯ã€Œå›³é¢ã«ã€Œç„¡æ–™ã€ã¨è¨˜è¼‰ãŒã‚ã‚‹ãŸã‚ã€
â–¡ å›³é¢ã«è¨˜è¼‰ãŒãªã„ä»˜å¸¯ã‚µãƒ¼ãƒ“ã‚¹ â†’ å¿…ãšcutã€ç†ç”±ã¯ã€Œå›³é¢ã«è¨˜è¼‰ãŒãªã„ãŸã‚ã€
â–¡ å›³é¢ã«è¨˜è¼‰ãŒã‚ã‚‹é …ç›® â†’ åŸºæœ¬çš„ã«fairã€ç†ç”±ã¯ã€Œå›³é¢ã«è¨˜è¼‰ãŒã‚ã‚Šã€
`;

    parts.push({ text: prompt });
    
    const result = await model.generateContent(parts);
    const responseText = result.response.text();
    console.log("AIå¿œç­”ã‚’å—ä¿¡ã—ã¾ã—ãŸ");
    
    // JSONãƒ‘ãƒ¼ã‚¹
    let json;
    try {
      const cleanedText = responseText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
      console.log("ãƒ‘ãƒ¼ã‚¹å‰ã®ãƒ†ã‚­ã‚¹ãƒˆï¼ˆæœ€åˆã®1000æ–‡å­—ï¼‰:", cleanedText.substring(0, 1000));
      json = JSON.parse(cleanedText);
    } catch (parseError: any) {
      console.error("JSON Parse Error:", parseError);
      console.error("Parse Error Details:", {
        message: parseError.message,
        name: parseError.name,
        stack: parseError.stack
      });
      console.error("Response text (full):", responseText);
      console.error("Response text length:", responseText.length);
      throw new Error(`AIã®å¿œç­”ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ${parseError.message}\nå¿œç­”ã®æœ€åˆã®500æ–‡å­—: ${responseText.substring(0, 500)}`);
    }
    
    // å¾Œå‡¦ç†
    if (json.items && Array.isArray(json.items)) {
      json.items = json.items.map((item: any) => {
        if (item.price_original === null) {
          return {
            ...item,
            price_original: 0,
            requires_confirmation: true,
            reason: item.reason + "ï¼ˆâ€»èª­ã¿å–ã‚Šè¦ç¢ºèªï¼‰"
          };
        }
        return {
          ...item,
          requires_confirmation: false
        };
      });
      
      const hasUnconfirmed = json.items.some((item: any) => item.requires_confirmation);
      json.has_unconfirmed_items = hasUnconfirmed;
      json.unconfirmed_item_names = json.items
        .filter((item: any) => item.requires_confirmation)
        .map((item: any) => item.name);
    }

    console.log("è¨ºæ–­å®Œäº†:", {
      items_count: json.items?.length,
      total_original: json.total_original,
      discount_amount: json.discount_amount
    });

    return NextResponse.json({ result: json });

  } catch (error: any) {
    console.error("Server Error:", error);
    
    let errorMessage = "è§£æã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
    let errorDetails = error.message || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼";
    
    if (error.status === 429 || error.message?.includes('429')) {
      errorMessage = "APIãƒ¬ãƒ¼ãƒˆåˆ¶é™ã«é”ã—ã¾ã—ãŸ";
      errorDetails = "ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
    } else if (error.message?.includes("JSON")) {
      errorMessage = "AIã‹ã‚‰ã®å¿œç­”ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ";
      errorDetails = "ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
    }
    
    return NextResponse.json({ 
      error: errorMessage, 
      details: errorDetails
    }, { status: error.status || 500 });
  }
}
